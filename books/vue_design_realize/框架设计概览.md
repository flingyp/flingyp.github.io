---
outline: deep
---

# 第一篇：框架设计概览

## 第一章：权衡的艺术

### 命令式和声明式

从范式上来看，视图层框架通常分为命令式和声明式。早年间流行的 Jquery 就是典型的命令式框架

而命令式框架的一大特点就是关注过程，而声明式框架更加关注结果

**命令式框架**：简单来说自然语言所描述的能够与代码产生一一对应关系，代码本身描述的是做事的过程，就更加符合我们的逻辑知觉

**声明式框架**：简单来说 Vue.js 帮我们封装了过程， Vue.js 内部实现也是命令式的，而暴露给用户的却更加声明式

### 性能与可维护的权衡

命令式和声明式各有缺点。在框架设计方面，则体现在性能与可维护性之间的权衡

**声明式代码的性能不优于命令式代码的性能，而声明式代码的可维护性更强**

这就体现了在框架设计层面上要做出关于可维护性与性能之间的权衡。在采用声明式提示可维护性的同时，性能就会有一定的损失，而框架的设计者要做的就是：**在保持可维护性的同时让性能损失最小化**

### 虚拟 DOM 的性能到底如何

**声明式代码的更新性能消耗 = 找出差异的性能消耗 + 直接修改的性能消耗**

因此，如果我们能够最小化找出差异的性能消耗，就可以让声明式代码的性能无限接近命令式代码的性能。而所谓的虚拟 DOM，就是为了最小化找出差异这一步的性能消耗而出现的

### 运行时和编译时

Vue.js 是一个编译时+运行时的框架，它在保持灵活性的基础上还能够通过编译手段分析用户提供的内容，从而进一步提升更新性能

Compiler 编译时：把 HTML 标签编译成树形结构的虚拟 DOM

Runtime 运行时：将虚拟 DOM 通过渲染函数转换为真实 DOM，渲染在页面上

## 第二章：框架设计的核心要素

### 提升用户开发体验

衡量一个框架是否足够优秀的指标之一就是看它的开发体验如何

在框架设计和开发过程中，提供友好的警告信息至关重要。如果这一点都做得不好，那么很可能会收到用户的抱怨。始终提供友好的警告信息不仅能够帮助用户快速定位问题，节省用户的时间，还能够让框架收获良好的口碑，让用户认可框架的专业性

### 控制框架代码的体积

框架的大小也是衡量框架的标准之一。在实现同样功能的情况下，当然是用的代码越少越好，这样体积就会越小

如果去看 Vue.js 的源码，就会发现每一个 warn 函数的调用都会配合 `__DEV__` 常量的检查

```ts
if (__DEV__ && !res) {
  warn(
    `Failed to mount app: mount target selector "${container}" returned null.`
  );
}
```

在开发环境下 `__DEV__` 常量设置为 true，上面的代码才有可能去执行

在生产环境下 `__DEV__` 常量设置为 false，上面的代码永远都不会执行，而这段代码就被称为 **Dead Code**，它不会出现在最终产物中，在构建资源的时候就会被移除。

这样就做到了 **在开发环境中为用户提供良好的警告信息的同时，不会增加生产环境代码的体积**

### 框架要做到良好的 Tree-Shaking

这个概念因为 Rollup.js 而普及。简单来说 Tree-Shaking 指的就是消除那些永远不会被执行的代码

想要实现 Tree-Shaking，必须满足一个条件就是，即模块必须是 ESM，因为 Tree-Shaking 依赖 ESM 的静态结构

### 框架应该输出怎样的构建产物

Vue.js 构建产物除了有环境上的区分之外，还会根据使用场景的不同而输出其他形式的产物

第一种 IIFE 格式：全称 **Immediately Invoked Function Expression** 即立即调用的函数表达式。用户希望可以直接在 HTML 页面中使用 `<script>` 标签引入框架并且使用

```html
<script src="./vue.global.prod.js"></script>
<script>
  const { createApp } = Vue;
</script>
```

第二种 ESM 格式：现在的主流浏览器对原生 ESM 的支持都不错，可以直接引入 ESM 格式的资源

```html
<script src="./vue.global.prod.js" type="module"></script>
```

第三种 CommonJs 格式：是在 Nodejs 环境中运行的，而非浏览器环境。服务端渲染会使用到

```ts
const Vue = require("vue");
```

### 特性开关

在设计框架中，框架会给用户提供诸多特性（或功能），例如我们提供 A、B、C 三个特性给用户。同时还提供了 a、b、c 三个对应的特性开关，用户可以通过设置开关来代表开启或关闭对应的特性，这会带来很多益处

1. 对应关闭的特性，可以利用 Tree-Shaking 机制让其不包含在最终的资源中
2. 该机制为框架设计带来了灵活性

### 错误处理

框架错误处理机制的好坏直接决定了用户应用程序的健壮性，还决定了用户开发时处理错误的心智负担

### 良好的 TypeScript 类型支持
