import{_ as s,c as n,o as a,a as l}from"./app.985dd558.js";const E=JSON.parse('{"title":"\u670D\u52A1\u5E38\u7528\u914D\u7F6E","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u4E2D\u95F4\u4EF6","slug":"\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u4E2D\u95F4\u4EF6","link":"#\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u4E2D\u95F4\u4EF6","children":[]},{"level":2,"title":"\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u62E6\u622A\u5668","slug":"\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u62E6\u622A\u5668","link":"#\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u62E6\u622A\u5668","children":[]},{"level":2,"title":"\u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668\uFF08\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\uFF09","slug":"\u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668-\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F","link":"#\u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668-\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F","children":[]},{"level":2,"title":"\u5168\u5C40\u5F02\u5E38\u8FC7\u6EE4\u5668\uFF08\u7EDF\u4E00\u5904\u7406\u5F02\u5E38\uFF09","slug":"\u5168\u5C40\u5F02\u5E38\u8FC7\u6EE4\u5668-\u7EDF\u4E00\u5904\u7406\u5F02\u5E38","link":"#\u5168\u5C40\u5F02\u5E38\u8FC7\u6EE4\u5668-\u7EDF\u4E00\u5904\u7406\u5F02\u5E38","children":[]},{"level":2,"title":"\u7528\u6237\u672C\u5730\u8BA4\u8BC1\u548C Jwt \u751F\u6210","slug":"\u7528\u6237\u672C\u5730\u8BA4\u8BC1\u548C-jwt-\u751F\u6210","link":"#\u7528\u6237\u672C\u5730\u8BA4\u8BC1\u548C-jwt-\u751F\u6210","children":[{"level":3,"title":"\u8BA4\u8BC1","slug":"\u8BA4\u8BC1","link":"#\u8BA4\u8BC1","children":[]}]},{"level":2,"title":"\u751F\u6210 JWT","slug":"\u751F\u6210-jwt","link":"#\u751F\u6210-jwt","children":[]},{"level":2,"title":"\u5B9E\u65BD JWT","slug":"\u5B9E\u65BD-jwt","link":"#\u5B9E\u65BD-jwt","children":[]},{"level":2,"title":"RBAC \u6743\u9650","slug":"rbac-\u6743\u9650","link":"#rbac-\u6743\u9650","children":[]},{"level":2,"title":"CORS \u8DE8\u8D44\u6E90\u8D21\u732E","slug":"cors-\u8DE8\u8D44\u6E90\u8D21\u732E","link":"#cors-\u8DE8\u8D44\u6E90\u8D21\u732E","children":[]},{"level":2,"title":"CSRF \u4FDD\u62A4","slug":"csrf-\u4FDD\u62A4","link":"#csrf-\u4FDD\u62A4","children":[]}],"relativePath":"services/Nest/configuration.md"}'),p={name:"services/Nest/configuration.md"},o=l(`<h1 id="\u670D\u52A1\u5E38\u7528\u914D\u7F6E" tabindex="-1">\u670D\u52A1\u5E38\u7528\u914D\u7F6E <a class="header-anchor" href="#\u670D\u52A1\u5E38\u7528\u914D\u7F6E" aria-hidden="true">#</a></h1><h2 id="\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u4E2D\u95F4\u4EF6" tabindex="-1">\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u4E2D\u95F4\u4EF6 <a class="header-anchor" href="#\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u4E2D\u95F4\u4EF6" aria-hidden="true">#</a></h2><p>\u6211\u4EEC\u53EF\u4EE5\u5728\u5904\u7406\u8BF7\u6C42\u4E4B\u524D\u5728\u63A7\u5236\u53F0\u8F93\u51FA\u5BF9\u5E94\u7684\u8BF7\u6C42\u4FE1\u606F\uFF0C\u8FD9\u65F6\u5019\u5C31\u9700\u8981\u4F7F\u7528\u5230\u6211\u4EEC\u7684\u4E2D\u95F4\u4EF6\u4E86</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// logger-middleware.ts</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Injectable</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Logger</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NestMiddleware</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">@nestjs/common</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Request</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Response</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NextFunction</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">express</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">logFormatMessage</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">req</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Request</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  const </span><span style="color:#BD976A;">logMessage</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#C98A7DAA;">\`</span><span style="color:#C98A7D;">Method: </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">req</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">method</span><span style="color:#666666;">}</span><span style="color:#C98A7D;"> </span><span style="color:#C99076;">\\n</span><span style="color:#C98A7D;"> Request original url: </span><span style="color:#666666;">\${</span></span>
<span class="line"><span style="color:#C98A7D;">    req</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">url</span></span>
<span class="line"><span style="color:#C98A7D;">  </span><span style="color:#666666;">}</span><span style="color:#C98A7D;"> </span><span style="color:#C99076;">\\n</span><span style="color:#C98A7D;"> IP: </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">req</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">ip</span><span style="color:#666666;">}</span><span style="color:#C98A7D;"> </span><span style="color:#C99076;">\\n</span><span style="color:#C98A7D;"> Query params: </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">JSON</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringify</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#C98A7D;">    req</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">query</span></span>
<span class="line"><span style="color:#C98A7D;">  </span><span style="color:#666666;">)</span><span style="color:#666666;">}</span><span style="color:#C98A7D;"> </span><span style="color:#C99076;">\\n</span><span style="color:#C98A7D;"> Body params: </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">JSON</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringify</span><span style="color:#666666;">(</span><span style="color:#C98A7D;">req</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">body</span><span style="color:#666666;">)</span><span style="color:#666666;">}</span><span style="color:#C98A7D;"> </span><span style="color:#C99076;">\\n</span><span style="color:#C98A7DAA;">\`</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#BD976A;">Logger</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#BD976A;">logMessage</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">LoggerMiddleware</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Injectable</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">LoggerMiddleware</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">implements</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">NestMiddleware</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">use</span><span style="color:#666666;">(</span><span style="color:#BD976A;">req</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Request</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">res</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Response</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">next</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">NextFunction</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">logFormatMessage</span><span style="color:#666666;">(</span><span style="color:#BD976A;">req</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">next</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// logger-middleware.ts</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Injectable</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Logger</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NestMiddleware</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">@nestjs/common</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Request</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Response</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NextFunction</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">express</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">logFormatMessage</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">req</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Request</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  const </span><span style="color:#B07D48;">logMessage</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B56959AA;">\`</span><span style="color:#B56959;">Method: </span><span style="color:#999999;">\${</span><span style="color:#B56959;">req</span><span style="color:#999999;">.</span><span style="color:#B56959;">method</span><span style="color:#999999;">}</span><span style="color:#B56959;"> </span><span style="color:#A65E2B;">\\n</span><span style="color:#B56959;"> Request original url: </span><span style="color:#999999;">\${</span></span>
<span class="line"><span style="color:#B56959;">    req</span><span style="color:#999999;">.</span><span style="color:#B56959;">url</span></span>
<span class="line"><span style="color:#B56959;">  </span><span style="color:#999999;">}</span><span style="color:#B56959;"> </span><span style="color:#A65E2B;">\\n</span><span style="color:#B56959;"> IP: </span><span style="color:#999999;">\${</span><span style="color:#B56959;">req</span><span style="color:#999999;">.</span><span style="color:#B56959;">ip</span><span style="color:#999999;">}</span><span style="color:#B56959;"> </span><span style="color:#A65E2B;">\\n</span><span style="color:#B56959;"> Query params: </span><span style="color:#999999;">\${</span><span style="color:#B56959;">JSON</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringify</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#B56959;">    req</span><span style="color:#999999;">.</span><span style="color:#B56959;">query</span></span>
<span class="line"><span style="color:#B56959;">  </span><span style="color:#999999;">)</span><span style="color:#999999;">}</span><span style="color:#B56959;"> </span><span style="color:#A65E2B;">\\n</span><span style="color:#B56959;"> Body params: </span><span style="color:#999999;">\${</span><span style="color:#B56959;">JSON</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringify</span><span style="color:#999999;">(</span><span style="color:#B56959;">req</span><span style="color:#999999;">.</span><span style="color:#B56959;">body</span><span style="color:#999999;">)</span><span style="color:#999999;">}</span><span style="color:#B56959;"> </span><span style="color:#A65E2B;">\\n</span><span style="color:#B56959AA;">\`</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#B07D48;">Logger</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B07D48;">logMessage</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">LoggerMiddleware</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Injectable</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">LoggerMiddleware</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">implements</span><span style="color:#393A34;"> </span><span style="color:#59873A;">NestMiddleware</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">use</span><span style="color:#999999;">(</span><span style="color:#B07D48;">req</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Request</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">res</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Response</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">next</span><span style="color:#999999;">: </span><span style="color:#2E808F;">NextFunction</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">logFormatMessage</span><span style="color:#999999;">(</span><span style="color:#B07D48;">req</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">next</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728 <code>app.module</code> \u6587\u4EF6\u914D\u7F6E\u4E2D\u95F4\u4EF6</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">AppModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">implements</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">NestModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">configure</span><span style="color:#666666;">(</span><span style="color:#BD976A;">consumer</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">MiddlewareConsumer</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">consumer</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">.</span><span style="color:#80A665;">apply</span><span style="color:#666666;">(</span><span style="color:#BD976A;">LoggerMiddleware</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">.</span><span style="color:#80A665;">forRoutes</span><span style="color:#666666;">({</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">path</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">*</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">method</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">RequestMethod</span><span style="color:#666666;">.</span><span style="color:#BD976A;">ALL</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">AppModule</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">implements</span><span style="color:#393A34;"> </span><span style="color:#59873A;">NestModule</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">configure</span><span style="color:#999999;">(</span><span style="color:#B07D48;">consumer</span><span style="color:#999999;">: </span><span style="color:#2E808F;">MiddlewareConsumer</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">consumer</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">.</span><span style="color:#59873A;">apply</span><span style="color:#999999;">(</span><span style="color:#B07D48;">LoggerMiddleware</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">.</span><span style="color:#59873A;">forRoutes</span><span style="color:#999999;">({</span><span style="color:#393A34;"> </span><span style="color:#998418;">path</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">*</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#998418;">method</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">RequestMethod</span><span style="color:#999999;">.</span><span style="color:#B07D48;">ALL</span><span style="color:#393A34;"> </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u62E6\u622A\u5668" tabindex="-1">\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u62E6\u622A\u5668 <a class="header-anchor" href="#\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u62E6\u622A\u5668" aria-hidden="true">#</a></h2><p>\u540C\u5168\u5C40\u65E5\u5FD7\u6253\u5370\u4E2D\u95F4\u4EF6\u529F\u80FD\u4E00\u6837</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">CallHandler</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">ExecutionContext</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">Injectable</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">Logger</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">NestInterceptor</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">@nestjs/common</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Request</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">express</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Observable</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tap</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">rxjs</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">useFormatDate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">@flypeng/tool</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Injectable</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">LoggingInterceptor</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">implements</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">NestInterceptor</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">intercept</span><span style="color:#666666;">(</span><span style="color:#BD976A;">context</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExecutionContext</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">next</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">CallHandler</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Observable</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">request</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">context</span><span style="color:#666666;">.</span><span style="color:#80A665;">switchToHttp</span><span style="color:#666666;">().</span><span style="color:#80A665;">getRequest</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">Request</span><span style="color:#666666;">&gt;();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">startNow</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#80A665;">useFormatDate</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">yyyy-MM-dd hh:mm:ss</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">Logger</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">\`</span><span style="color:#C98A7D;">Request start... </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">startNow</span><span style="color:#666666;">}</span><span style="color:#C98A7DAA;">\`</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">LoggingInterceptor</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">\`</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7D;">Request-URL: </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">request</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">url</span><span style="color:#666666;">}</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7DAA;">\`</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">\`</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7D;">Request-Method: </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">request</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">method</span><span style="color:#666666;">}</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7DAA;">\`</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">\`</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7D;">Request-Ip: </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">request</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">ip</span><span style="color:#666666;">}</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7DAA;">\`</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C98A7DAA;">\`</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7D;">Request-QueryParams: </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">JSON</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringify</span><span style="color:#666666;">(</span><span style="color:#C98A7D;">request</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">query</span><span style="color:#666666;">)</span><span style="color:#666666;">}</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7DAA;">\`</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">\`</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7D;">Request-Body: </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">JSON</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringify</span><span style="color:#666666;">(</span><span style="color:#C98A7D;">request</span><span style="color:#666666;">.</span><span style="color:#C98A7D;">body</span><span style="color:#666666;">)</span><span style="color:#666666;">}</span><span style="color:#C99076;">\\t\\t\\t</span><span style="color:#C98A7DAA;">\`</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">next</span><span style="color:#666666;">.</span><span style="color:#80A665;">handle</span><span style="color:#666666;">().</span><span style="color:#80A665;">pipe</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">tap</span><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">endNow</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#80A665;">useFormatDate</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">yyyy-MM-dd hh:mm:ss</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">Logger</span><span style="color:#666666;">.</span><span style="color:#80A665;">log</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">\`</span><span style="color:#C98A7D;">Request ending... </span><span style="color:#666666;">\${</span><span style="color:#C98A7D;">endNow</span><span style="color:#666666;">}</span><span style="color:#C98A7DAA;">\`</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">LoggingInterceptor</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">}),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">CallHandler</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">ExecutionContext</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">Injectable</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">Logger</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">NestInterceptor</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">@nestjs/common</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Request</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">express</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Observable</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tap</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">rxjs</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">useFormatDate</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">@flypeng/tool</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Injectable</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">LoggingInterceptor</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">implements</span><span style="color:#393A34;"> </span><span style="color:#59873A;">NestInterceptor</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">intercept</span><span style="color:#999999;">(</span><span style="color:#B07D48;">context</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExecutionContext</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">next</span><span style="color:#999999;">: </span><span style="color:#2E808F;">CallHandler</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Observable</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">any</span><span style="color:#999999;">&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">request</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">context</span><span style="color:#999999;">.</span><span style="color:#59873A;">switchToHttp</span><span style="color:#999999;">().</span><span style="color:#59873A;">getRequest</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">Request</span><span style="color:#999999;">&gt;();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">startNow</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#59873A;">useFormatDate</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">yyyy-MM-dd hh:mm:ss</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">Logger</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">\`</span><span style="color:#B56959;">Request start... </span><span style="color:#999999;">\${</span><span style="color:#B56959;">startNow</span><span style="color:#999999;">}</span><span style="color:#B56959AA;">\`</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">LoggingInterceptor</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">\`</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959;">Request-URL: </span><span style="color:#999999;">\${</span><span style="color:#B56959;">request</span><span style="color:#999999;">.</span><span style="color:#B56959;">url</span><span style="color:#999999;">}</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959AA;">\`</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">\`</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959;">Request-Method: </span><span style="color:#999999;">\${</span><span style="color:#B56959;">request</span><span style="color:#999999;">.</span><span style="color:#B56959;">method</span><span style="color:#999999;">}</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959AA;">\`</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">\`</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959;">Request-Ip: </span><span style="color:#999999;">\${</span><span style="color:#B56959;">request</span><span style="color:#999999;">.</span><span style="color:#B56959;">ip</span><span style="color:#999999;">}</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959AA;">\`</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959AA;">\`</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959;">Request-QueryParams: </span><span style="color:#999999;">\${</span><span style="color:#B56959;">JSON</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringify</span><span style="color:#999999;">(</span><span style="color:#B56959;">request</span><span style="color:#999999;">.</span><span style="color:#B56959;">query</span><span style="color:#999999;">)</span><span style="color:#999999;">}</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959AA;">\`</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">\`</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959;">Request-Body: </span><span style="color:#999999;">\${</span><span style="color:#B56959;">JSON</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringify</span><span style="color:#999999;">(</span><span style="color:#B56959;">request</span><span style="color:#999999;">.</span><span style="color:#B56959;">body</span><span style="color:#999999;">)</span><span style="color:#999999;">}</span><span style="color:#A65E2B;">\\t\\t\\t</span><span style="color:#B56959AA;">\`</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">next</span><span style="color:#999999;">.</span><span style="color:#59873A;">handle</span><span style="color:#999999;">().</span><span style="color:#59873A;">pipe</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">tap</span><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">endNow</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#59873A;">useFormatDate</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">yyyy-MM-dd hh:mm:ss</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">Logger</span><span style="color:#999999;">.</span><span style="color:#59873A;">log</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">\`</span><span style="color:#B56959;">Request ending... </span><span style="color:#999999;">\${</span><span style="color:#B56959;">endNow</span><span style="color:#999999;">}</span><span style="color:#B56959AA;">\`</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">LoggingInterceptor</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">}),</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728 <code>main.ts</code> \u914D\u7F6E\u62E6\u622A\u5668</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// \u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668\uFF08\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\uFF09</span></span>
<span class="line"><span style="color:#BD976A;">app</span><span style="color:#666666;">.</span><span style="color:#80A665;">useGlobalInterceptors</span><span style="color:#666666;">(</span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">LoggingInterceptor</span><span style="color:#666666;">());</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// \u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668\uFF08\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\uFF09</span></span>
<span class="line"><span style="color:#B07D48;">app</span><span style="color:#999999;">.</span><span style="color:#59873A;">useGlobalInterceptors</span><span style="color:#999999;">(</span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">LoggingInterceptor</span><span style="color:#999999;">());</span></span>
<span class="line"></span></code></pre></div><h2 id="\u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668-\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F" tabindex="-1">\u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668\uFF08\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\uFF09 <a class="header-anchor" href="#\u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668-\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F" aria-hidden="true">#</a></h2><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">CallHandler</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">ExecutionContext</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">HttpStatus</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">Injectable</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">NestInterceptor</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">@nestjs/common</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">map</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Observable</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">rxjs</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * Common Response Structure</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">CommonResponse</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">code</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HttpStatus</span><span style="color:#666666;">.</span><span style="color:#BD976A;">OK</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">message</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">\u64CD\u4F5C\u6210\u529F</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">data</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#BD976A;">data</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">unknown</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">code</span><span style="color:#CB7676;">?</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">number</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">message</span><span style="color:#CB7676;">?</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">string</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">code</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">code</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">message</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">message</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">data</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">data</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * Global Response Interceptor</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Injectable</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">ResponseInterceptor</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">implements</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">NestInterceptor</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">intercept</span><span style="color:#666666;">(</span><span style="color:#BD976A;">context</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExecutionContext</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">next</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">CallHandler</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Observable</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">next</span><span style="color:#666666;">.</span><span style="color:#80A665;">handle</span><span style="color:#666666;">().</span><span style="color:#80A665;">pipe</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">map</span><span style="color:#666666;">((</span><span style="color:#BD976A;">value</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">unknown</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">value</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">instanceof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">CommonResponse</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">value</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">CommonResponse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">value</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">200</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">\u64CD\u4F5C\u6210\u529F</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">CallHandler</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">ExecutionContext</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">HttpStatus</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">Injectable</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">NestInterceptor</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">@nestjs/common</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">map</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Observable</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">rxjs</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * Common Response Structure</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">CommonResponse</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">code</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HttpStatus</span><span style="color:#999999;">.</span><span style="color:#B07D48;">OK</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">message</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">\u64CD\u4F5C\u6210\u529F</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">data</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#B07D48;">data</span><span style="color:#999999;">: </span><span style="color:#2E808F;">unknown</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">code</span><span style="color:#AB5959;">?</span><span style="color:#999999;">: </span><span style="color:#2E808F;">number</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">message</span><span style="color:#AB5959;">?</span><span style="color:#999999;">: </span><span style="color:#2E808F;">string</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">code</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">code</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">message</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">message</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">data</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">data</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * Global Response Interceptor</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Injectable</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">ResponseInterceptor</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">implements</span><span style="color:#393A34;"> </span><span style="color:#59873A;">NestInterceptor</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">intercept</span><span style="color:#999999;">(</span><span style="color:#B07D48;">context</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExecutionContext</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">next</span><span style="color:#999999;">: </span><span style="color:#2E808F;">CallHandler</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Observable</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">any</span><span style="color:#999999;">&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">next</span><span style="color:#999999;">.</span><span style="color:#59873A;">handle</span><span style="color:#999999;">().</span><span style="color:#59873A;">pipe</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">map</span><span style="color:#999999;">((</span><span style="color:#B07D48;">value</span><span style="color:#999999;">: </span><span style="color:#2E808F;">unknown</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">value</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">instanceof</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">CommonResponse</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">value</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">CommonResponse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">value</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">200</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">\u64CD\u4F5C\u6210\u529F</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728 <code>main.ts</code> \u914D\u7F6E\u62E6\u622A\u5668</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// \u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668\uFF08\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\uFF09</span></span>
<span class="line"><span style="color:#BD976A;">app</span><span style="color:#666666;">.</span><span style="color:#80A665;">useGlobalInterceptors</span><span style="color:#666666;">(</span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">TransformResInterceptor</span><span style="color:#666666;">());</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// \u5168\u5C40\u54CD\u5E94\u62E6\u622A\u5668\uFF08\u7EDF\u4E00\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\uFF09</span></span>
<span class="line"><span style="color:#B07D48;">app</span><span style="color:#999999;">.</span><span style="color:#59873A;">useGlobalInterceptors</span><span style="color:#999999;">(</span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">TransformResInterceptor</span><span style="color:#999999;">());</span></span>
<span class="line"></span></code></pre></div><h2 id="\u5168\u5C40\u5F02\u5E38\u8FC7\u6EE4\u5668-\u7EDF\u4E00\u5904\u7406\u5F02\u5E38" tabindex="-1">\u5168\u5C40\u5F02\u5E38\u8FC7\u6EE4\u5668\uFF08\u7EDF\u4E00\u5904\u7406\u5F02\u5E38\uFF09 <a class="header-anchor" href="#\u5168\u5C40\u5F02\u5E38\u8FC7\u6EE4\u5668-\u7EDF\u4E00\u5904\u7406\u5F02\u5E38" aria-hidden="true">#</a></h2><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">ArgumentsHost</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">Catch</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">ExceptionFilter</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">HttpException</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">HttpStatus</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">Logger</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">@nestjs/common</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Response</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">express</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Catch</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">HttpExceptionFilter</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">implements</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">ExceptionFilter</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">catch</span><span style="color:#666666;">(</span><span style="color:#BD976A;">exception</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">unknown</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">host</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ArgumentsHost</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">ctx</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">host</span><span style="color:#666666;">.</span><span style="color:#80A665;">switchToHttp</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">request</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">ctx</span><span style="color:#666666;">.</span><span style="color:#80A665;">getRequest</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">Request</span><span style="color:#666666;">&gt;();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">response</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">ctx</span><span style="color:#666666;">.</span><span style="color:#80A665;">getResponse</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">Response</span><span style="color:#666666;">&gt;();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">Logger</span><span style="color:#666666;">.</span><span style="color:#80A665;">error</span><span style="color:#666666;">(</span><span style="color:#BD976A;">exception</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">Logging</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">path</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">request</span><span style="color:#666666;">.</span><span style="color:#BD976A;">url</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">status</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">exception</span><span style="color:#CB7676;"> instanceof </span><span style="color:#5DA9A7;">HttpException</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">exception</span><span style="color:#666666;">.</span><span style="color:#80A665;">getStatus</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HttpStatus</span><span style="color:#666666;">.</span><span style="color:#BD976A;">INTERNAL_SERVER_ERROR</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">message</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">exception</span><span style="color:#CB7676;"> instanceof </span><span style="color:#5DA9A7;">HttpException</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">JSON</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringify</span><span style="color:#666666;">(</span><span style="color:#BD976A;">exception</span><span style="color:#666666;">.</span><span style="color:#80A665;">getResponse</span><span style="color:#666666;">())</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">\u64CD\u4F5C\u5931\u8D25</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">response</span><span style="color:#666666;">.</span><span style="color:#80A665;">header</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">Content-Type</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">application/json; charset=utf-8</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">response</span><span style="color:#666666;">.</span><span style="color:#80A665;">status</span><span style="color:#666666;">(</span><span style="color:#BD976A;">status</span><span style="color:#666666;">).</span><span style="color:#80A665;">json</span><span style="color:#666666;">({</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">path</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">status</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">message</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">timestamp</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Date</span><span style="color:#666666;">().</span><span style="color:#80A665;">toISOString</span><span style="color:#666666;">(),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">ArgumentsHost</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">Catch</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">ExceptionFilter</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">HttpException</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">HttpStatus</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">Logger</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">@nestjs/common</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Response</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">express</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Catch</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">HttpExceptionFilter</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">implements</span><span style="color:#393A34;"> </span><span style="color:#59873A;">ExceptionFilter</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">catch</span><span style="color:#999999;">(</span><span style="color:#B07D48;">exception</span><span style="color:#999999;">: </span><span style="color:#2E808F;">unknown</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">host</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ArgumentsHost</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">ctx</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">host</span><span style="color:#999999;">.</span><span style="color:#59873A;">switchToHttp</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">request</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">ctx</span><span style="color:#999999;">.</span><span style="color:#59873A;">getRequest</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">Request</span><span style="color:#999999;">&gt;();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">response</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">ctx</span><span style="color:#999999;">.</span><span style="color:#59873A;">getResponse</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">Response</span><span style="color:#999999;">&gt;();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">Logger</span><span style="color:#999999;">.</span><span style="color:#59873A;">error</span><span style="color:#999999;">(</span><span style="color:#B07D48;">exception</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">Logging</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">path</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">request</span><span style="color:#999999;">.</span><span style="color:#B07D48;">url</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">status</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">exception</span><span style="color:#AB5959;"> instanceof </span><span style="color:#2E808F;">HttpException</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">exception</span><span style="color:#999999;">.</span><span style="color:#59873A;">getStatus</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HttpStatus</span><span style="color:#999999;">.</span><span style="color:#B07D48;">INTERNAL_SERVER_ERROR</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">message</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">exception</span><span style="color:#AB5959;"> instanceof </span><span style="color:#2E808F;">HttpException</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">JSON</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringify</span><span style="color:#999999;">(</span><span style="color:#B07D48;">exception</span><span style="color:#999999;">.</span><span style="color:#59873A;">getResponse</span><span style="color:#999999;">())</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">\u64CD\u4F5C\u5931\u8D25</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">response</span><span style="color:#999999;">.</span><span style="color:#59873A;">header</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">Content-Type</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">application/json; charset=utf-8</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">response</span><span style="color:#999999;">.</span><span style="color:#59873A;">status</span><span style="color:#999999;">(</span><span style="color:#B07D48;">status</span><span style="color:#999999;">).</span><span style="color:#59873A;">json</span><span style="color:#999999;">({</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">path</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">status</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">message</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">timestamp</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Date</span><span style="color:#999999;">().</span><span style="color:#59873A;">toISOString</span><span style="color:#999999;">(),</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5728 <code>main.ts</code> \u914D\u7F6E\u8FC7\u6EE4\u5668</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// \u5168\u5C40\u5F02\u5E38\u8FC7\u6EE4\u5668\uFF08\u7EDF\u4E00\u5904\u7406\u5F02\u5E38\u8BF7\u6C42\uFF09</span></span>
<span class="line"><span style="color:#BD976A;">app</span><span style="color:#666666;">.</span><span style="color:#80A665;">useGlobalFilters</span><span style="color:#666666;">(</span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">HttpExceptionFilter</span><span style="color:#666666;">());</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// \u5168\u5C40\u5F02\u5E38\u8FC7\u6EE4\u5668\uFF08\u7EDF\u4E00\u5904\u7406\u5F02\u5E38\u8BF7\u6C42\uFF09</span></span>
<span class="line"><span style="color:#B07D48;">app</span><span style="color:#999999;">.</span><span style="color:#59873A;">useGlobalFilters</span><span style="color:#999999;">(</span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">HttpExceptionFilter</span><span style="color:#999999;">());</span></span>
<span class="line"></span></code></pre></div><h2 id="\u7528\u6237\u672C\u5730\u8BA4\u8BC1\u548C-jwt-\u751F\u6210" tabindex="-1">\u7528\u6237\u672C\u5730\u8BA4\u8BC1\u548C Jwt \u751F\u6210 <a class="header-anchor" href="#\u7528\u6237\u672C\u5730\u8BA4\u8BC1\u548C-jwt-\u751F\u6210" aria-hidden="true">#</a></h2><h3 id="\u8BA4\u8BC1" tabindex="-1">\u8BA4\u8BC1 <a class="header-anchor" href="#\u8BA4\u8BC1" aria-hidden="true">#</a></h3><p>passport \u662F\u76EE\u524D\u6700\u6D41\u884C\u7684 node.js \u8BA4\u8BC1\u5E93\uFF0C\u5B83\u5177\u6709\u4E30\u5BCC\u7684\u7B56\u7565\u751F\u6001\u7CFB\u7EDF\uFF0C\u53EF\u5B9E\u65BD\u5404\u79CD\u8EAB\u4EFD\u9A8C\u8BC1\u673A\u5236\u3002\u800C @nestjs/passport \u6A21\u5757\u5C06\u8BE5\u6A21\u5F0F\u5305\u88C5\u5E76\u6807\u51C6\u5316\u4E3A\u719F\u6089\u7684 Nest \u6784\u9020</p><p>\u5B89\u88C5\uFF1A</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#DBD7CAEE;">pnpm add @nestjs/passport passport passport-local</span></span>
<span class="line"><span style="color:#DBD7CAEE;">pnpm add @types/passport-local -D</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#393A34;">pnpm add @nestjs/passport passport passport-local</span></span>
<span class="line"><span style="color:#393A34;">pnpm add @types/passport-local -D</span></span>
<span class="line"></span></code></pre></div><p>\u4E3B\u8981\u6B65\u9AA4\u662F\uFF1A</p><ol><li><p>\u5EFA\u7ACB\u4E00\u4E2A <code>AuthModule</code> \u3001<code>AuthController</code> \u548C <code>AuthService</code> \u5728\u6B64\u6A21\u5757\u505A\u8EAB\u4EFD\u8BA4\u8BC1</p></li><li><p>\u5B9E\u73B0 Passport \u672C\u5730\u8EAB\u4EFD\u9A8C\u8BC1\u7B56\u7565\uFF0C\u5728\u6A21\u5757\u4E0B\u521B\u5EFA\u4E00\u4E2A <code>local.strategy.ts</code> \u6587\u4EF6</p></li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// auth/local.strategy.ts</span></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Injectable</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">LocalStrategy</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">extends</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">PassportStrategy</span><span style="color:#666666;">(</span><span style="color:#BD976A;">Strategy</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#CB7676;">private</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">readonly</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">authService</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">AuthService</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">super</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// \u7528\u6237\u8EAB\u4EFD\u8BA4\u8BC1\u903B\u8F91</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">async</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">validate</span><span style="color:#666666;">(</span><span style="color:#BD976A;">username</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">string</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">password</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">string</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Promise</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u6839\u636E\u9700\u6C42\u6765\u5B9A\u4E49\u8BA4\u8BC1\u903B\u8F91</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">user</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">xxxx</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// const user = await this.authService.validateUser(username, password);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">user</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">throw</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">UnauthorizedException</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">user</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// auth/local.strategy.ts</span></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Injectable</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">LocalStrategy</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">extends</span><span style="color:#393A34;"> </span><span style="color:#59873A;">PassportStrategy</span><span style="color:#999999;">(</span><span style="color:#B07D48;">Strategy</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#AB5959;">private</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">readonly</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">authService</span><span style="color:#999999;">: </span><span style="color:#2E808F;">AuthService</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">super</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// \u7528\u6237\u8EAB\u4EFD\u8BA4\u8BC1\u903B\u8F91</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">async</span><span style="color:#393A34;"> </span><span style="color:#59873A;">validate</span><span style="color:#999999;">(</span><span style="color:#B07D48;">username</span><span style="color:#999999;">: </span><span style="color:#2E808F;">string</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">password</span><span style="color:#999999;">: </span><span style="color:#2E808F;">string</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Promise</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">any</span><span style="color:#999999;">&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u6839\u636E\u9700\u6C42\u6765\u5B9A\u4E49\u8BA4\u8BC1\u903B\u8F91</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">user</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">xxxx</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// const user = await this.authService.validateUser(username, password);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">user</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">throw</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">UnauthorizedException</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">user</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><ol start="3"><li>\u5C06 <strong>PassportModule</strong>\u3001<strong>LocalStrategy</strong> \u670D\u52A1\u5728 <code>AuthModule</code> \u4E2D\u8FDB\u884C\u63D0\u4F9B\u51FA\u6765\u4EE5\u4F9B\u5176\u4ED6\u670D\u52A1\u4F7F\u7528</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Module</span><span style="color:#666666;">({</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">imports</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">UsersModule</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PassportModule</span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">providers</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">AuthService</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">LocalStrategy</span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">AuthModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Module</span><span style="color:#999999;">({</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">imports</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">UsersModule</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PassportModule</span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">providers</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">AuthService</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">LocalStrategy</span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">AuthModule</span><span style="color:#393A34;"> </span><span style="color:#999999;">{}</span></span>
<span class="line"></span></code></pre></div><ol start="4"><li>\u5728\u767B\u5F55\u63A5\u53E3\u6CE8\u5165\u4E00\u4E2A\u63A7\u5236\u5B88\u536B\uFF0C\u5E76\u5E94\u7528\u5185\u7F6E\u7684\u5B88\u536B\u6765\u542F\u52A8 <code>Passport-local</code> \u6D41</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">UseGuards</span><span style="color:#666666;">(</span><span style="color:#80A665;">AuthGuard</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">local</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u6DFB\u52A0\u5B88\u536B</span></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Post</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">login</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#BD976A;">async</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">login</span><span style="color:#666666;">(</span><span style="color:#DBD7CAEE;">@</span><span style="color:#80A665;">Body</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">loginAccountDto</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">LoginAccountDto</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> @</span><span style="color:#80A665;">Req</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">request</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// Passport \u6839\u636E\u4ECE validate() \u65B9\u6CD5\u8FD4\u56DE\u7684\u503C\u81EA\u52A8\u521B\u5EFA\u4E00\u4E2A user \u5BF9\u8C61\uFF0C\u5E76\u5C06\u5176\u4F5C\u4E3A request.user \u5206\u914D\u7ED9\u8BF7\u6C42\u5BF9\u8C61\uFF0C\u4E4B\u540E\u518D\u53BB\u4ECB\u5165JWT</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">request</span><span style="color:#666666;">.</span><span style="color:#BD976A;">user</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// return this.authService.createToken(request.user as SysAccountEntity);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">UseGuards</span><span style="color:#999999;">(</span><span style="color:#59873A;">AuthGuard</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">local</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u6DFB\u52A0\u5B88\u536B</span></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Post</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">login</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#B07D48;">async</span><span style="color:#393A34;"> </span><span style="color:#59873A;">login</span><span style="color:#999999;">(</span><span style="color:#393A34;">@</span><span style="color:#59873A;">Body</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">loginAccountDto</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">LoginAccountDto</span><span style="color:#999999;">,</span><span style="color:#393A34;"> @</span><span style="color:#59873A;">Req</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">request</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// Passport \u6839\u636E\u4ECE validate() \u65B9\u6CD5\u8FD4\u56DE\u7684\u503C\u81EA\u52A8\u521B\u5EFA\u4E00\u4E2A user \u5BF9\u8C61\uFF0C\u5E76\u5C06\u5176\u4F5C\u4E3A request.user \u5206\u914D\u7ED9\u8BF7\u6C42\u5BF9\u8C61\uFF0C\u4E4B\u540E\u518D\u53BB\u4ECB\u5165JWT</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">request</span><span style="color:#999999;">.</span><span style="color:#B07D48;">user</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// return this.authService.createToken(request.user as SysAccountEntity);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="\u751F\u6210-jwt" tabindex="-1">\u751F\u6210 JWT <a class="header-anchor" href="#\u751F\u6210-jwt" aria-hidden="true">#</a></h2><ol><li>\u5B89\u88C5</li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#DBD7CAEE;">pnpm add @nestjs/jwt passport-jwt</span></span>
<span class="line"><span style="color:#DBD7CAEE;">pnpm add @types/passport-jwt -D</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#393A34;">pnpm add @nestjs/jwt passport-jwt</span></span>
<span class="line"><span style="color:#393A34;">pnpm add @types/passport-jwt -D</span></span>
<span class="line"></span></code></pre></div><ol start="2"><li>\u63A5\u7740\u4E0A\u9762\u8BA4\u8BC1\u90E8\u5206\uFF0C\u5728 <code>AuthService</code> \u53EF\u7F16\u5199\u751F\u6210 Token \u7684\u4EE3\u7801</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Injectable</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">AuthService</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">private</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">readonly</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">usersService</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">UsersService</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">private</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">readonly</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">jwtService</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">JwtService</span></span>
<span class="line"><span style="color:#666666;">  )</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">async</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">login</span><span style="color:#666666;">(</span><span style="color:#BD976A;">user</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">payload</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span><span style="color:#CB7676;"> </span><span style="color:#B8A965;">username</span><span style="color:#666666;">:</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">user</span><span style="color:#666666;">.</span><span style="color:#BD976A;">username</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#B8A965;">sub</span><span style="color:#666666;">:</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">user</span><span style="color:#666666;">.</span><span style="color:#BD976A;">userId</span><span style="color:#CB7676;"> </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// jwtService.sign() \u7528\u4E8E\u751F\u6210\u4E00\u4E2A Token</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">access_token</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">jwtService</span><span style="color:#666666;">.</span><span style="color:#80A665;">sign</span><span style="color:#666666;">(</span><span style="color:#BD976A;">payload</span><span style="color:#666666;">),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Injectable</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">AuthService</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">private</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">readonly</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">usersService</span><span style="color:#999999;">: </span><span style="color:#2E808F;">UsersService</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">private</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">readonly</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">jwtService</span><span style="color:#999999;">: </span><span style="color:#2E808F;">JwtService</span></span>
<span class="line"><span style="color:#999999;">  )</span><span style="color:#393A34;"> </span><span style="color:#999999;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">async</span><span style="color:#393A34;"> </span><span style="color:#59873A;">login</span><span style="color:#999999;">(</span><span style="color:#B07D48;">user</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">payload</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span><span style="color:#AB5959;"> </span><span style="color:#998418;">username</span><span style="color:#999999;">:</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">user</span><span style="color:#999999;">.</span><span style="color:#B07D48;">username</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#998418;">sub</span><span style="color:#999999;">:</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">user</span><span style="color:#999999;">.</span><span style="color:#B07D48;">userId</span><span style="color:#AB5959;"> </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// jwtService.sign() \u7528\u4E8E\u751F\u6210\u4E00\u4E2A Token</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">access_token</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">jwtService</span><span style="color:#999999;">.</span><span style="color:#59873A;">sign</span><span style="color:#999999;">(</span><span style="color:#B07D48;">payload</span><span style="color:#999999;">),</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><ol start="3"><li>\u540C\u65F6\u9700\u8981\u5728 <code>auth.module.ts</code> \u6587\u4EF6\u53BB\u914D\u7F6E <code>JwtModule</code> \u6A21\u5757</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// auth/constant.ts</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#CB7676;"> const </span><span style="color:#BD976A;">jwtConstants</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#B8A965;">secret</span><span style="color:#666666;">:</span><span style="color:#CB7676;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">secretKey</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#758575DD;">// \u7B7E\u540D\u79D8\u94A5</span></span>
<span class="line"><span style="color:#666666;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// auth/constant.ts</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#AB5959;"> const </span><span style="color:#B07D48;">jwtConstants</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#998418;">secret</span><span style="color:#999999;">:</span><span style="color:#AB5959;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">secretKey</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#A0ADA0;">// \u7B7E\u540D\u79D8\u94A5</span></span>
<span class="line"><span style="color:#999999;">};</span></span>
<span class="line"></span></code></pre></div><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// auth/auth.module.ts</span></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Module</span><span style="color:#666666;">({</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">imports</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">UsersModule</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">PassportModule</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">JwtModule</span><span style="color:#666666;">.</span><span style="color:#80A665;">register</span><span style="color:#666666;">({</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">secret</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">jwtConstants</span><span style="color:#666666;">.</span><span style="color:#BD976A;">secret</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u79D8\u94A5</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">signOptions</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">expiresIn</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">60s</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">},</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">providers</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">AuthService</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">LocalStrategy</span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">exports</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">AuthService</span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">AuthModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// auth/auth.module.ts</span></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Module</span><span style="color:#999999;">({</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">imports</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">UsersModule</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">PassportModule</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">JwtModule</span><span style="color:#999999;">.</span><span style="color:#59873A;">register</span><span style="color:#999999;">({</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">secret</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">jwtConstants</span><span style="color:#999999;">.</span><span style="color:#B07D48;">secret</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u79D8\u94A5</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">signOptions</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#998418;">expiresIn</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">60s</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#999999;">},</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}),</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">providers</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">AuthService</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">LocalStrategy</span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">exports</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">AuthService</span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">AuthModule</span><span style="color:#393A34;"> </span><span style="color:#999999;">{}</span></span>
<span class="line"></span></code></pre></div><ol start="4"><li>\u4FEE\u6539\u8BA4\u8BC1\u65F6\u7684\u767B\u5F55\u63A5\u53E3</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">UseGuards</span><span style="color:#666666;">(</span><span style="color:#80A665;">AuthGuard</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">local</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">))</span></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Post</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">auth/login</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#BD976A;">async</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">login</span><span style="color:#666666;">(</span><span style="color:#DBD7CAEE;">@</span><span style="color:#80A665;">Request</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">req</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// LocalStrategy \u8BA4\u8BC1\u903B\u8F91\u901A\u8FC7\u540E\uFF0C\u5C31\u4F1A\u8D70\u5230\u8FD9\u6765</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">authService</span><span style="color:#666666;">.</span><span style="color:#80A665;">login</span><span style="color:#666666;">(</span><span style="color:#BD976A;">req</span><span style="color:#666666;">.</span><span style="color:#BD976A;">user</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">UseGuards</span><span style="color:#999999;">(</span><span style="color:#59873A;">AuthGuard</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">local</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">))</span></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Post</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">auth/login</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#B07D48;">async</span><span style="color:#393A34;"> </span><span style="color:#59873A;">login</span><span style="color:#999999;">(</span><span style="color:#393A34;">@</span><span style="color:#59873A;">Request</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">req</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// LocalStrategy \u8BA4\u8BC1\u903B\u8F91\u901A\u8FC7\u540E\uFF0C\u5C31\u4F1A\u8D70\u5230\u8FD9\u6765</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">authService</span><span style="color:#999999;">.</span><span style="color:#59873A;">login</span><span style="color:#999999;">(</span><span style="color:#B07D48;">req</span><span style="color:#999999;">.</span><span style="color:#B07D48;">user</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="\u5B9E\u65BD-jwt" tabindex="-1">\u5B9E\u65BD JWT <a class="header-anchor" href="#\u5B9E\u65BD-jwt" aria-hidden="true">#</a></h2><p>\u901A\u8FC7\u8981\u6C42\u5728\u8BF7\u6C42\u65F6\u63D0\u4F9B\u6709\u6548\u7684 JWT \u6765\u4FDD\u62A4\u6211\u4EEC\u7684\u63A5\u53E3</p><ol><li>\u521B\u5EFA\u4E00\u4E2A <code>JwtStrategy</code> JWT \u8BA4\u8BC1\u7B56\u7565\uFF0C\u5B9E\u73B0 validate \u903B\u8F91\u6765\u6821\u9A8C Token \u7684\u6709\u6548\u6027</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// auth/jwt.strategy.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Injectable</span><span style="color:#666666;">()</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">JwtStorageStrategy</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">extends</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">PassportStrategy</span><span style="color:#666666;">(</span><span style="color:#BD976A;">Strategy</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#CB7676;">private</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">readonly</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">authService</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">AuthService</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u8BF7\u6C42\u5934 \u643A\u5E26Token\uFF0C\u683C\u5F0F\u5982\u4E0B</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Authorization: Bearer xxxx</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u53EA\u7528\u63A5\u53E3\u643A\u5E26\u4E86 @UseGuards(AuthGuard(&#39;jwt&#39;))\u7684\u5B88\u536B \u90FD\u662F\u9700\u8981Token\u7684</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u5B83\u4F1A\u81EA\u52A8\u53BB\u89E3\u6790\u8BF7\u6C42\u5934\u643A\u5E26\u7684Token\uFF0C</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">super</span><span style="color:#666666;">({</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">jwtFromRequest</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ExtractJwt</span><span style="color:#666666;">.</span><span style="color:#80A665;">fromAuthHeaderAsBearerToken</span><span style="color:#666666;">(),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">secretOrKey</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">jwtConstants</span><span style="color:#666666;">.</span><span style="color:#BD976A;">secret</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">as</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">StrategyOptions</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">   * \u6821\u9A8CToken\u7684\u6709\u6548\u6027</span></span>
<span class="line"><span style="color:#758575DD;">   * </span><span style="color:#666666;">@</span><span style="color:#4D9375;">param</span><span style="color:#758575DD;"> </span><span style="color:#BD976A;">token</span></span>
<span class="line"><span style="color:#758575DD;">   * </span><span style="color:#666666;">@</span><span style="color:#4D9375;">returns</span></span>
<span class="line"><span style="color:#758575DD;">   */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">async</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">validate</span><span style="color:#666666;">(</span><span style="color:#BD976A;">token</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">existUser</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">await</span><span style="color:#CB7676;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">authService</span><span style="color:#666666;">.</span><span style="color:#80A665;">findAccountById</span><span style="color:#666666;">(</span><span style="color:#BD976A;">token</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sub</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">existUser</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">UnauthorizedException</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">token\u65E0\u6548!</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">existUser</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// auth/jwt.strategy.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Injectable</span><span style="color:#999999;">()</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">JwtStorageStrategy</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">extends</span><span style="color:#393A34;"> </span><span style="color:#59873A;">PassportStrategy</span><span style="color:#999999;">(</span><span style="color:#B07D48;">Strategy</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#AB5959;">private</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">readonly</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">authService</span><span style="color:#999999;">: </span><span style="color:#2E808F;">AuthService</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u8BF7\u6C42\u5934 \u643A\u5E26Token\uFF0C\u683C\u5F0F\u5982\u4E0B</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Authorization: Bearer xxxx</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u53EA\u7528\u63A5\u53E3\u643A\u5E26\u4E86 @UseGuards(AuthGuard(&#39;jwt&#39;))\u7684\u5B88\u536B \u90FD\u662F\u9700\u8981Token\u7684</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u5B83\u4F1A\u81EA\u52A8\u53BB\u89E3\u6790\u8BF7\u6C42\u5934\u643A\u5E26\u7684Token\uFF0C</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">super</span><span style="color:#999999;">({</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">jwtFromRequest</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ExtractJwt</span><span style="color:#999999;">.</span><span style="color:#59873A;">fromAuthHeaderAsBearerToken</span><span style="color:#999999;">(),</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">secretOrKey</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">jwtConstants</span><span style="color:#999999;">.</span><span style="color:#B07D48;">secret</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">as</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">StrategyOptions</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">   * \u6821\u9A8CToken\u7684\u6709\u6548\u6027</span></span>
<span class="line"><span style="color:#A0ADA0;">   * </span><span style="color:#999999;">@</span><span style="color:#1E754F;">param</span><span style="color:#A0ADA0;"> </span><span style="color:#B07D48;">token</span></span>
<span class="line"><span style="color:#A0ADA0;">   * </span><span style="color:#999999;">@</span><span style="color:#1E754F;">returns</span></span>
<span class="line"><span style="color:#A0ADA0;">   */</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">async</span><span style="color:#393A34;"> </span><span style="color:#59873A;">validate</span><span style="color:#999999;">(</span><span style="color:#B07D48;">token</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">existUser</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">await</span><span style="color:#AB5959;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">authService</span><span style="color:#999999;">.</span><span style="color:#59873A;">findAccountById</span><span style="color:#999999;">(</span><span style="color:#B07D48;">token</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sub</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">existUser</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">UnauthorizedException</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">token\u65E0\u6548!</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">existUser</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><ol start="2"><li>\u5728 <code>AuthModule</code> \u6A21\u5757\u4E2D\u63D0\u4F9B\u670D\u52A1\uFF0C\u4F9B\u5176\u4ED6\u6A21\u5757\u4F7F\u7528</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Module</span><span style="color:#666666;">({</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">imports</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">UsersModule</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">PassportModule</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">JwtModule</span><span style="color:#666666;">.</span><span style="color:#80A665;">register</span><span style="color:#666666;">({</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">secret</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">jwtConstants</span><span style="color:#666666;">.</span><span style="color:#BD976A;">secret</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u79D8\u94A5</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#B8A965;">signOptions</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">expiresIn</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">60s</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">},</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">providers</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">AuthService</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">LocalStrategy</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">JwtStorageStrategy</span><span style="color:#666666;">],</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u65B0\u589E\u670D\u52A1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">exports</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">AuthService</span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">AuthModule</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Module</span><span style="color:#999999;">({</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">imports</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">UsersModule</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">PassportModule</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">JwtModule</span><span style="color:#999999;">.</span><span style="color:#59873A;">register</span><span style="color:#999999;">({</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">secret</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">jwtConstants</span><span style="color:#999999;">.</span><span style="color:#B07D48;">secret</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u79D8\u94A5</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#998418;">signOptions</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#998418;">expiresIn</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">60s</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#999999;">},</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}),</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">providers</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">AuthService</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">LocalStrategy</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">JwtStorageStrategy</span><span style="color:#999999;">],</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u65B0\u589E\u670D\u52A1</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">exports</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">AuthService</span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">AuthModule</span><span style="color:#393A34;"> </span><span style="color:#999999;">{}</span></span>
<span class="line"></span></code></pre></div><ol start="3"><li>\u5BF9\u5E94\u9700\u8981\u767B\u5F55\u540E\u624D\u53EF\u8BBF\u95EE\u7684\u8DEF\u7531\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u6DFB\u52A0\u5BF9\u5E94\u5B88\u536B</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">UseGuards</span><span style="color:#666666;">(</span><span style="color:#80A665;">AuthGuard</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">jwt</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u6DFB\u52A0\u5B88\u536B\u6765\u4FDD\u62A4\u8DEF\u7531</span></span>
<span class="line"><span style="color:#666666;">@</span><span style="color:#80A665;">Get</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">profile</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#80A665;">getProfile</span><span style="color:#666666;">(</span><span style="color:#DBD7CAEE;">@</span><span style="color:#80A665;">Request</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">req</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">req</span><span style="color:#666666;">.</span><span style="color:#BD976A;">user</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">UseGuards</span><span style="color:#999999;">(</span><span style="color:#59873A;">AuthGuard</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">jwt</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u6DFB\u52A0\u5B88\u536B\u6765\u4FDD\u62A4\u8DEF\u7531</span></span>
<span class="line"><span style="color:#999999;">@</span><span style="color:#59873A;">Get</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">profile</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#59873A;">getProfile</span><span style="color:#999999;">(</span><span style="color:#393A34;">@</span><span style="color:#59873A;">Request</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">req</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">req</span><span style="color:#999999;">.</span><span style="color:#B07D48;">user</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="rbac-\u6743\u9650" tabindex="-1">RBAC \u6743\u9650 <a class="header-anchor" href="#rbac-\u6743\u9650" aria-hidden="true">#</a></h2><p>\u76F8\u5BF9\u8BA4\u8BC1\u90E8\u5206\u6765\u8BF4\u5E76\u4E0D\u5F88\u5F88\u96BE\uFF0C\u4F46\u4E5F\u6BD4\u8F83\u9EBB\u70E6\u9700\u8981\u914D\u7F6E\u6570\u636E\u5E93</p><p>\u5177\u4F53\u5982\u4F55\u914D\u7F6E\u53EF\u53C2\u7167 <a href="https://docs.nestjs.cn/9/security?id=%e6%9d%83%e9%99%90%ef%bc%88authorization%ef%bc%89" target="_blank" rel="noreferrer">\u6587\u6863</a></p><h2 id="cors-\u8DE8\u8D44\u6E90\u8D21\u732E" tabindex="-1">CORS \u8DE8\u8D44\u6E90\u8D21\u732E <a class="header-anchor" href="#cors-\u8DE8\u8D44\u6E90\u8D21\u732E" aria-hidden="true">#</a></h2><p>\u5904\u7406\u6D4F\u89C8\u5668\u8DE8\u57DF\u95EE\u9898\uFF0C\u5FC5\u987B\u8C03\u7528 <code>enableCors()</code> \u65B9\u6CD5\u5F00\u542F\u8DE8\u57DF</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">const </span><span style="color:#BD976A;">app</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">await</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">NestFactory</span><span style="color:#666666;">.</span><span style="color:#80A665;">create</span><span style="color:#666666;">(</span><span style="color:#BD976A;">AppModule</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#758575DD;">// \u5F00\u542F\u8DE8\u57DF</span></span>
<span class="line"><span style="color:#BD976A;">app</span><span style="color:#666666;">.</span><span style="color:#80A665;">enableCors</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#4D9375;">await</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">app</span><span style="color:#666666;">.</span><span style="color:#80A665;">listen</span><span style="color:#666666;">(</span><span style="color:#4C9A91;">3000</span><span style="color:#666666;">);</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">const </span><span style="color:#B07D48;">app</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">await</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">NestFactory</span><span style="color:#999999;">.</span><span style="color:#59873A;">create</span><span style="color:#999999;">(</span><span style="color:#B07D48;">AppModule</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#A0ADA0;">// \u5F00\u542F\u8DE8\u57DF</span></span>
<span class="line"><span style="color:#B07D48;">app</span><span style="color:#999999;">.</span><span style="color:#59873A;">enableCors</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#1E754F;">await</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">app</span><span style="color:#999999;">.</span><span style="color:#59873A;">listen</span><span style="color:#999999;">(</span><span style="color:#2F798A;">3000</span><span style="color:#999999;">);</span></span>
<span class="line"></span></code></pre></div><h2 id="csrf-\u4FDD\u62A4" tabindex="-1">CSRF \u4FDD\u62A4 <a class="header-anchor" href="#csrf-\u4FDD\u62A4" aria-hidden="true">#</a></h2><p>\u8DE8\u7AD9\u70B9\u8BF7\u6C42\u4F2A\u9020\uFF08\u79F0\u4E3A CSRF \u6216 XSRF\uFF09\u662F\u4E00\u79CD\u6076\u610F\u5229\u7528\u7F51\u7AD9\uFF0C\u5176\u4E2D\u672A\u7ECF\u6388\u6743\u7684\u547D\u4EE4\u4ECE Web \u5E94\u7528\u7A0B\u5E8F\u4FE1\u4EFB\u7684\u7528\u6237\u4F20\u8F93</p><p>\u5B89\u88C5\uFF1A</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#BD976A;">pnpm</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">add</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">csurf</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#B07D48;">pnpm</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">add</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">csurf</span></span>
<span class="line"></span></code></pre></div><p>\u914D\u7F6E\u4E3A\u5168\u5C40\u4E2D\u95F4\u4EF6</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">*</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">as</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">csurf</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">csurf</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#BD976A;">app</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">await</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">NestFactory</span><span style="color:#666666;">.</span><span style="color:#80A665;">create</span><span style="color:#666666;">(</span><span style="color:#BD976A;">AppModule</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#BD976A;">app</span><span style="color:#666666;">.</span><span style="color:#80A665;">use</span><span style="color:#666666;">(</span><span style="color:#80A665;">csurf</span><span style="color:#666666;">());</span></span>
<span class="line"><span style="color:#4D9375;">await</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">app</span><span style="color:#666666;">.</span><span style="color:#80A665;">listen</span><span style="color:#666666;">(</span><span style="color:#4C9A91;">3000</span><span style="color:#666666;">);</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">*</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">as</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">csurf</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">csurf</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#B07D48;">app</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">await</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">NestFactory</span><span style="color:#999999;">.</span><span style="color:#59873A;">create</span><span style="color:#999999;">(</span><span style="color:#B07D48;">AppModule</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#B07D48;">app</span><span style="color:#999999;">.</span><span style="color:#59873A;">use</span><span style="color:#999999;">(</span><span style="color:#59873A;">csurf</span><span style="color:#999999;">());</span></span>
<span class="line"><span style="color:#1E754F;">await</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">app</span><span style="color:#999999;">.</span><span style="color:#59873A;">listen</span><span style="color:#999999;">(</span><span style="color:#2F798A;">3000</span><span style="color:#999999;">);</span></span>
<span class="line"></span></code></pre></div>`,61),e=[o];function t(c,r,y,A,D,i){return a(),n("div",null,e)}const C=s(p,[["render",t]]);export{E as __pageData,C as default};
