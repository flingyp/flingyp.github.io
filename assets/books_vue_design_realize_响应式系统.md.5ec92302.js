import{_ as s,c as n,o as a,a as p}from"./app.dcd45ec4.js";const i=JSON.parse('{"title":"\u7B2C\u4E8C\u7BC7\uFF1A\u54CD\u5E94\u5F0F\u7CFB\u7EDF","description":"","frontmatter":{"outline":"deep"},"headers":[{"level":2,"title":"\u7B2C\u56DB\u7AE0\uFF1A\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u7684\u4F5C\u7528\u4E0E\u5B9E\u73B0","slug":"\u7B2C\u56DB\u7AE0-\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u7684\u4F5C\u7528\u4E0E\u5B9E\u73B0","link":"#\u7B2C\u56DB\u7AE0-\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u7684\u4F5C\u7528\u4E0E\u5B9E\u73B0","children":[{"level":3,"title":"reactive.ts","slug":"reactive-ts","link":"#reactive-ts","children":[]},{"level":3,"title":"baseHandler.ts","slug":"basehandler-ts","link":"#basehandler-ts","children":[]},{"level":3,"title":"effect.ts","slug":"effect-ts","link":"#effect-ts","children":[]},{"level":3,"title":"4.4 \u5206\u652F\u5207\u6362\u4E0E cleanup","slug":"_4-4-\u5206\u652F\u5207\u6362\u4E0E-cleanup","link":"#_4-4-\u5206\u652F\u5207\u6362\u4E0E-cleanup","children":[]},{"level":3,"title":"4.5 \u5D4C\u5957\u7684 effect \u4E0E effect \u6808","slug":"_4-5-\u5D4C\u5957\u7684-effect-\u4E0E-effect-\u6808","link":"#_4-5-\u5D4C\u5957\u7684-effect-\u4E0E-effect-\u6808","children":[]},{"level":3,"title":"4.6 \u907F\u514D\u65E0\u9650\u9012\u5F52\u5FAA\u73AF","slug":"_4-6-\u907F\u514D\u65E0\u9650\u9012\u5F52\u5FAA\u73AF","link":"#_4-6-\u907F\u514D\u65E0\u9650\u9012\u5F52\u5FAA\u73AF","children":[]},{"level":3,"title":"4.7 \u8C03\u5EA6\u6267\u884C","slug":"_4-7-\u8C03\u5EA6\u6267\u884C","link":"#_4-7-\u8C03\u5EA6\u6267\u884C","children":[]},{"level":3,"title":"4.8 \u8BA1\u7B97\u5C5E\u6027 computed","slug":"_4-8-\u8BA1\u7B97\u5C5E\u6027-computed","link":"#_4-8-\u8BA1\u7B97\u5C5E\u6027-computed","children":[]}]}],"relativePath":"books/vue_design_realize/\u54CD\u5E94\u5F0F\u7CFB\u7EDF.md"}'),l={name:"books/vue_design_realize/\u54CD\u5E94\u5F0F\u7CFB\u7EDF.md"},o=p(`<h1 id="\u7B2C\u4E8C\u7BC7-\u54CD\u5E94\u5F0F\u7CFB\u7EDF" tabindex="-1">\u7B2C\u4E8C\u7BC7\uFF1A\u54CD\u5E94\u5F0F\u7CFB\u7EDF <a class="header-anchor" href="#\u7B2C\u4E8C\u7BC7-\u54CD\u5E94\u5F0F\u7CFB\u7EDF" aria-hidden="true">#</a></h1><h2 id="\u7B2C\u56DB\u7AE0-\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u7684\u4F5C\u7528\u4E0E\u5B9E\u73B0" tabindex="-1">\u7B2C\u56DB\u7AE0\uFF1A\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u7684\u4F5C\u7528\u4E0E\u5B9E\u73B0 <a class="header-anchor" href="#\u7B2C\u56DB\u7AE0-\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u7684\u4F5C\u7528\u4E0E\u5B9E\u73B0" aria-hidden="true">#</a></h2><p>Vue3 \u91C7\u7528 Proxy \u6765\u5B9E\u73B0\u54CD\u5E94\u5F0F\u6570\u636E\u7684\u4EE3\u7406\u3002\u526F\u4F5C\u7528\u51FD\u6570\u6307\u7684\u5C31\u662F\u4F1A\u4EA7\u751F\u526F\u4F5C\u7528\u7684\u51FD\u6570</p><h3 id="reactive-ts" tabindex="-1"><code>reactive.ts</code> <a class="header-anchor" href="#reactive-ts" aria-hidden="true">#</a></h3><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isObject</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">@vue/shared</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">mutableHandlers</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">./baseHandler</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">enum</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">ReactiveFlags</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">IS_REACTIVE</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">__v_isReactive</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// \u6620\u5C04\u8868 -&gt; \u6E90\u5BF9\u8C61:\u4EE3\u7406\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#BD976A;">reactiveMap</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#80A665;">WeakMap</span><span style="color:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">reactive</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// \u4E0D\u662F\u5BF9\u8C61\u7C7B\u578B\u7684\u53D8\u91CF</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#80A665;">isObject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// \u5982\u679C\u6E90\u5BF9\u8C61\u5C31\u662F\u4EE3\u7406\u5BF9\u8C61\u5C31\u76F4\u63A5\u8FD4\u56DE\uFF08\u539F\u56E0\u662F\u8BBF\u95EE\u4EE3\u7406\u5BF9\u8C61\u7684\u5C5E\u6027\u4F1A\u8D70\u5230Get\u65B9\u6CD5\uFF0C\u6240\u4EE5\u901A\u8FC7\u4E00\u4E2A\u6807\u8BC6\u6765\u5224\u5B9A\uFF09</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">[</span><span style="color:#BD976A;">ReactiveFlags</span><span style="color:#666666;">.</span><span style="color:#BD976A;">IS_REACTIVE</span><span style="color:#666666;">])</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">target</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// \u5982\u679Ctarget\u5BF9\u8C61\u5DF2\u7ECF\u88AB\u4EE3\u7406\u8FC7\u4E86\u5C31\u8FD4\u56DE\u4EE3\u7406\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">existsProxy</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">reactiveMap</span><span style="color:#666666;">.</span><span style="color:#80A665;">get</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">existsProxy</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">existsProxy</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">proxy</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#80A665;">Proxy</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">mutableHandlers</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// \u7F13\u5B58\u4E00\u4E0B \u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61 \u4E0B\u6B21\u5728\u8FDB\u884C\u4EE3\u7406\u7684\u65F6\u5019\u76F4\u63A5\u62FF\u51FA\u6765\u5373\u53EF</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">reactiveMap</span><span style="color:#666666;">.</span><span style="color:#80A665;">set</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">proxy</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">proxy</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isObject</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">@vue/shared</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">mutableHandlers</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">./baseHandler</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">enum</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">ReactiveFlags</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">IS_REACTIVE</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">__v_isReactive</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// \u6620\u5C04\u8868 -&gt; \u6E90\u5BF9\u8C61:\u4EE3\u7406\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#B07D48;">reactiveMap</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#59873A;">WeakMap</span><span style="color:#999999;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">reactive</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// \u4E0D\u662F\u5BF9\u8C61\u7C7B\u578B\u7684\u53D8\u91CF</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#59873A;">isObject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// \u5982\u679C\u6E90\u5BF9\u8C61\u5C31\u662F\u4EE3\u7406\u5BF9\u8C61\u5C31\u76F4\u63A5\u8FD4\u56DE\uFF08\u539F\u56E0\u662F\u8BBF\u95EE\u4EE3\u7406\u5BF9\u8C61\u7684\u5C5E\u6027\u4F1A\u8D70\u5230Get\u65B9\u6CD5\uFF0C\u6240\u4EE5\u901A\u8FC7\u4E00\u4E2A\u6807\u8BC6\u6765\u5224\u5B9A\uFF09</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">[</span><span style="color:#B07D48;">ReactiveFlags</span><span style="color:#999999;">.</span><span style="color:#B07D48;">IS_REACTIVE</span><span style="color:#999999;">])</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">target</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// \u5982\u679Ctarget\u5BF9\u8C61\u5DF2\u7ECF\u88AB\u4EE3\u7406\u8FC7\u4E86\u5C31\u8FD4\u56DE\u4EE3\u7406\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">existsProxy</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">reactiveMap</span><span style="color:#999999;">.</span><span style="color:#59873A;">get</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">existsProxy</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">existsProxy</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">proxy</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#59873A;">Proxy</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">mutableHandlers</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// \u7F13\u5B58\u4E00\u4E0B \u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61 \u4E0B\u6B21\u5728\u8FDB\u884C\u4EE3\u7406\u7684\u65F6\u5019\u76F4\u63A5\u62FF\u51FA\u6765\u5373\u53EF</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">reactiveMap</span><span style="color:#999999;">.</span><span style="color:#59873A;">set</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">proxy</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">proxy</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="basehandler-ts" tabindex="-1"><code>baseHandler.ts</code> <a class="header-anchor" href="#basehandler-ts" aria-hidden="true">#</a></h3><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isObject</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">@vue/shared</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">track</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">trigger</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">./effect</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reactive</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ReactiveFlags</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">./reactive</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// target\uFF1A\u6E90\u76EE\u6807\u5BF9\u8C61, key\uFF1A\u8BBF\u95EE\u7684\u5C5E\u6027, value\uFF1A\u8BBE\u7F6E\u7684\u65B0\u503C, receiver\uFF1A\u5F53\u524D\u7684\u4EE3\u7406\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#CB7676;"> const </span><span style="color:#BD976A;">mutableHandlers</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#80A665;">get</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">receiver</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u4EE3\u8868target\u5DF2\u7ECF\u662F\u4EE3\u7406\u5BF9\u8C61\u4E86</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">if</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">key</span><span style="color:#CB7676;"> === </span><span style="color:#BD976A;">ReactiveFlags</span><span style="color:#666666;">.</span><span style="color:#BD976A;">IS_REACTIVE</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">return</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u4F9D\u8D56\u6536\u96C6</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#80A665;">track</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Reflect\u5904\u7406\u4E86this\u95EE\u9898</span></span>
<span class="line"><span style="color:#CB7676;">    let </span><span style="color:#BD976A;">r</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">Reflect</span><span style="color:#666666;">.</span><span style="color:#80A665;">get</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">receiver</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u5904\u7406\u6DF1\u5EA6\u4EE3\u7406\u60C5\u51B5\uFF08\u53EA\u7528\u7528\u6237\u53D6\u503C\u7684\u65F6\u5019\u624D\u4F1A\u4E8C\u6B21\u4EE3\u7406\uFF0C\u4E0D\u7528\u62C5\u5FC3\u6027\u80FD\uFF09</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">if</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#80A665;">isObject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">r</span><span style="color:#666666;">))</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#4D9375;">return</span><span style="color:#CB7676;"> </span><span style="color:#80A665;">reactive</span><span style="color:#666666;">(</span><span style="color:#BD976A;">r</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">return</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">r</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#80A665;">set</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">value</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">receiver</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">    let </span><span style="color:#BD976A;">oldValue</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">target</span><span style="color:#666666;">[</span><span style="color:#BD976A;">key</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Reflect\u5904\u7406\u4E86this\u95EE\u9898</span></span>
<span class="line"><span style="color:#CB7676;">    let </span><span style="color:#BD976A;">r</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">Reflect</span><span style="color:#666666;">.</span><span style="color:#80A665;">set</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">value</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">receiver</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">if</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">oldValue</span><span style="color:#CB7676;"> !== </span><span style="color:#BD976A;">value</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u6D3E\u53D1\u66F4\u65B0</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#80A665;">trigger</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">value</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">oldValue</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">return</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">r</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#666666;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isObject</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">@vue/shared</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">track</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">trigger</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">./effect</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reactive</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ReactiveFlags</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">./reactive</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// target\uFF1A\u6E90\u76EE\u6807\u5BF9\u8C61, key\uFF1A\u8BBF\u95EE\u7684\u5C5E\u6027, value\uFF1A\u8BBE\u7F6E\u7684\u65B0\u503C, receiver\uFF1A\u5F53\u524D\u7684\u4EE3\u7406\u5BF9\u8C61</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#AB5959;"> const </span><span style="color:#B07D48;">mutableHandlers</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#59873A;">get</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">receiver</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u4EE3\u8868target\u5DF2\u7ECF\u662F\u4EE3\u7406\u5BF9\u8C61\u4E86</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">if</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">key</span><span style="color:#AB5959;"> === </span><span style="color:#B07D48;">ReactiveFlags</span><span style="color:#999999;">.</span><span style="color:#B07D48;">IS_REACTIVE</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">return</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u4F9D\u8D56\u6536\u96C6</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#59873A;">track</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Reflect\u5904\u7406\u4E86this\u95EE\u9898</span></span>
<span class="line"><span style="color:#AB5959;">    let </span><span style="color:#B07D48;">r</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">Reflect</span><span style="color:#999999;">.</span><span style="color:#59873A;">get</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">receiver</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u5904\u7406\u6DF1\u5EA6\u4EE3\u7406\u60C5\u51B5\uFF08\u53EA\u7528\u7528\u6237\u53D6\u503C\u7684\u65F6\u5019\u624D\u4F1A\u4E8C\u6B21\u4EE3\u7406\uFF0C\u4E0D\u7528\u62C5\u5FC3\u6027\u80FD\uFF09</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">if</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#59873A;">isObject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">r</span><span style="color:#999999;">))</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#1E754F;">return</span><span style="color:#AB5959;"> </span><span style="color:#59873A;">reactive</span><span style="color:#999999;">(</span><span style="color:#B07D48;">r</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">return</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">r</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#59873A;">set</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">value</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">receiver</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">    let </span><span style="color:#B07D48;">oldValue</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">target</span><span style="color:#999999;">[</span><span style="color:#B07D48;">key</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Reflect\u5904\u7406\u4E86this\u95EE\u9898</span></span>
<span class="line"><span style="color:#AB5959;">    let </span><span style="color:#B07D48;">r</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">Reflect</span><span style="color:#999999;">.</span><span style="color:#59873A;">set</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">value</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">receiver</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">if</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">oldValue</span><span style="color:#AB5959;"> !== </span><span style="color:#B07D48;">value</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u6D3E\u53D1\u66F4\u65B0</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#59873A;">trigger</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">value</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">oldValue</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">return</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">r</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#999999;">};</span></span>
<span class="line"></span></code></pre></div><h3 id="effect-ts" tabindex="-1"><code>effect.ts</code> <a class="header-anchor" href="#effect-ts" aria-hidden="true">#</a></h3><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#CB7676;"> let </span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570 ReactiveEffect</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// \u6BCF\u6B21\u6267\u884C\u4F9D\u8D56\u6536\u96C6\u4E4B\u524D\u6267\u884C\u4F9D\u8D56\u6E05\u7406\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">cleanupEffect</span><span style="color:#666666;">(</span><span style="color:#BD976A;">effect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">let </span><span style="color:#666666;">{</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">deps</span><span style="color:#CB7676;"> </span><span style="color:#666666;">}</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">let </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">deps</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;">++</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">deps</span><span style="color:#666666;">[</span><span style="color:#BD976A;">i</span><span style="color:#666666;">].</span><span style="color:#80A665;">delete</span><span style="color:#666666;">(</span><span style="color:#BD976A;">effect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">deps</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">ReactiveEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">active</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">deps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[];</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u8BB0\u5F55\u8BE5\u526F\u4F5C\u7528\u51FD\u6570\u4F9D\u8D56\u54EA\u4E00\u4E9B\u4F9D\u8D56\u9879</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u5904\u7406\u526F\u4F5C\u7528\u51FD\u6570\u5D4C\u5957\u95EE\u9898</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// scheduler \u8C03\u5EA6\u6267\u884C\uFF0C\u6211\u4EEC\u53EF\u4EE5\u81EA\u5DF1\u51B3\u5B9A\u526F\u4F5C\u7528\u51FD\u6570\u6267\u884C\u7684\u65F6\u673A\u3001\u6B21\u6570\u3001\u53CA\u6267\u884C\u65B9\u5F0F</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fn</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">private</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">scheduler</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">run</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u5982\u679C\u662F\u975E\u6FC0\u6D3B\u72B6\u6001\u53EA\u8981\u6267\u884C\u4E00\u6B21\u51FD\u6570\u5373\u53EF</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">active</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">fn</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u5176\u4ED6\u60C5\u51B5\u4E0B \u610F\u601D\u7740\u662F\u6FC0\u6D3B\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u8BB0\u5F55\u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">activeEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u6BCF\u6B21\u6267\u884Ceffect\u4E4B\u524D \u5E94\u8BE5\u6E05\u7406\u4E00\u904Deffect\u4E2D\u4F9D\u8D56\u7684\u6240\u6709\u5C5E\u6027</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">cleanupEffect</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">fn</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">finally</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">activeEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parent</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">stop</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">active</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">cleanupEffect</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">);</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u5148\u5C06effect\u6E05\u9664\u6389</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">active</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u5728\u5C06\u5176\u53D8\u6210\u5931\u6D3B\u72B6\u6001</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">effect</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fn</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">options</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;"> =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{})</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">_effect</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#80A665;">ReactiveEffect</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fn</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">options</span><span style="color:#666666;">.</span><span style="color:#BD976A;">scheduler</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">_effect</span><span style="color:#666666;">.</span><span style="color:#80A665;">run</span><span style="color:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">runner</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">_effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">run</span><span style="color:#666666;">.</span><span style="color:#80A665;">bind</span><span style="color:#666666;">(</span><span style="color:#BD976A;">_effect</span><span style="color:#666666;">);</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u4FDD\u8BC1 _effect\u6267\u884C\u7684\u65F6\u5019this\u662F\u5F53\u524D\u7684effect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">runner</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">_effect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">runner</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// WeakMap: { Map: Set }</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#BD976A;">targetMap</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#80A665;">WeakMap</span><span style="color:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * \u4F9D\u8D56\u6536\u96C6</span></span>
<span class="line"><span style="color:#758575DD;"> * </span><span style="color:#666666;">@</span><span style="color:#4D9375;">param</span><span style="color:#758575DD;"> </span><span style="color:#BD976A;">target</span></span>
<span class="line"><span style="color:#758575DD;"> * </span><span style="color:#666666;">@</span><span style="color:#4D9375;">param</span><span style="color:#758575DD;"> </span><span style="color:#BD976A;">key</span></span>
<span class="line"><span style="color:#758575DD;"> * </span><span style="color:#666666;">@</span><span style="color:#4D9375;">returns</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">track</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// \u53D6\u503C\u64CD\u4F5C\u6CA1\u6709\u53D1\u751F\u5728effect\u4E2D</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">let </span><span style="color:#BD976A;">depsMap</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">targetMap</span><span style="color:#666666;">.</span><span style="color:#80A665;">get</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">depsMap</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">targetMap</span><span style="color:#666666;">.</span><span style="color:#80A665;">set</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">depsMap</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Map</span><span style="color:#666666;">()));</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">let </span><span style="color:#BD976A;">dep</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">depsMap</span><span style="color:#666666;">.</span><span style="color:#80A665;">get</span><span style="color:#666666;">(</span><span style="color:#BD976A;">key</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">depsMap</span><span style="color:#666666;">.</span><span style="color:#80A665;">set</span><span style="color:#666666;">(</span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">dep</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Set</span><span style="color:#666666;">()));</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">trackEffects</span><span style="color:#666666;">(</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">trackEffects</span><span style="color:#666666;">(</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">let </span><span style="color:#BD976A;">shouldTrack</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> !</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">.</span><span style="color:#80A665;">has</span><span style="color:#666666;">(</span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// \u4E00\u4E2A\u5C5E\u6027\u5BF9\u5E94\u591A\u4E2Aeffect\uFF0C\u4E00\u4E2Aeffect\u5BF9\u5E94\u7740\u591A\u79CD\u5C5E\u6027</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// \u5C5E\u6027\u548Ceffect\u7684\u5173\u7CFB\u662F\u591A\u5BF9\u5BF9\u7684\u5173\u7CFB</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">shouldTrack</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">dep</span><span style="color:#666666;">.</span><span style="color:#80A665;">add</span><span style="color:#666666;">(</span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">deps</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">);</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u540E\u7EED\u9700\u8981\u901A\u8FC7effect\u6765\u6E05\u7406\u7684\u65F6\u5019\u53EF\u4EE5\u53BB\u4F7F\u7528</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * \u6D3E\u53D1\u66F4\u65B0</span></span>
<span class="line"><span style="color:#758575DD;"> * </span><span style="color:#666666;">@</span><span style="color:#4D9375;">param</span><span style="color:#758575DD;"> </span><span style="color:#BD976A;">target</span></span>
<span class="line"><span style="color:#758575DD;"> * </span><span style="color:#666666;">@</span><span style="color:#4D9375;">param</span><span style="color:#758575DD;"> </span><span style="color:#BD976A;">key</span></span>
<span class="line"><span style="color:#758575DD;"> * </span><span style="color:#666666;">@</span><span style="color:#4D9375;">param</span><span style="color:#758575DD;"> </span><span style="color:#BD976A;">newValue</span></span>
<span class="line"><span style="color:#758575DD;"> * </span><span style="color:#666666;">@</span><span style="color:#4D9375;">param</span><span style="color:#758575DD;"> </span><span style="color:#BD976A;">oldValue</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">trigger</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newValue</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">oldValue</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">depsMap</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">targetMap</span><span style="color:#666666;">.</span><span style="color:#80A665;">get</span><span style="color:#666666;">(</span><span style="color:#BD976A;">target</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">depsMap</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">dep</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">depsMap</span><span style="color:#666666;">.</span><span style="color:#80A665;">get</span><span style="color:#666666;">(</span><span style="color:#BD976A;">key</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">triggerEffects</span><span style="color:#666666;">(</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">triggerEffects</span><span style="color:#666666;">(</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">effects</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">[...</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">effects</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">((</span><span style="color:#BD976A;">effect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">activeEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">scheduler</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#80A665;">run</span><span style="color:#666666;">();</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u6BCF\u6B21\u8C03run\u65B9\u6CD5\u90FD\u4F1A\u91CD\u65B0\u4F9D\u8D56\u6536\u96C6</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#80A665;">scheduler</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#AB5959;"> let </span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570 ReactiveEffect</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// \u6BCF\u6B21\u6267\u884C\u4F9D\u8D56\u6536\u96C6\u4E4B\u524D\u6267\u884C\u4F9D\u8D56\u6E05\u7406\u64CD\u4F5C</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">cleanupEffect</span><span style="color:#999999;">(</span><span style="color:#B07D48;">effect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">let </span><span style="color:#999999;">{</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">deps</span><span style="color:#AB5959;"> </span><span style="color:#999999;">}</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">for</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">let </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">deps</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;">++</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">deps</span><span style="color:#999999;">[</span><span style="color:#B07D48;">i</span><span style="color:#999999;">].</span><span style="color:#59873A;">delete</span><span style="color:#999999;">(</span><span style="color:#B07D48;">effect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">deps</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">ReactiveEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">active</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">deps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[];</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u8BB0\u5F55\u8BE5\u526F\u4F5C\u7528\u51FD\u6570\u4F9D\u8D56\u54EA\u4E00\u4E9B\u4F9D\u8D56\u9879</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u5904\u7406\u526F\u4F5C\u7528\u51FD\u6570\u5D4C\u5957\u95EE\u9898</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// scheduler \u8C03\u5EA6\u6267\u884C\uFF0C\u6211\u4EEC\u53EF\u4EE5\u81EA\u5DF1\u51B3\u5B9A\u526F\u4F5C\u7528\u51FD\u6570\u6267\u884C\u7684\u65F6\u673A\u3001\u6B21\u6570\u3001\u53CA\u6267\u884C\u65B9\u5F0F</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fn</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">private</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">scheduler</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">run</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u5982\u679C\u662F\u975E\u6FC0\u6D3B\u72B6\u6001\u53EA\u8981\u6267\u884C\u4E00\u6B21\u51FD\u6570\u5373\u53EF</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">active</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">fn</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u5176\u4ED6\u60C5\u51B5\u4E0B \u610F\u601D\u7740\u662F\u6FC0\u6D3B\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u8BB0\u5F55\u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">activeEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u6BCF\u6B21\u6267\u884Ceffect\u4E4B\u524D \u5E94\u8BE5\u6E05\u7406\u4E00\u904Deffect\u4E2D\u4F9D\u8D56\u7684\u6240\u6709\u5C5E\u6027</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">cleanupEffect</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">fn</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">finally</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">activeEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parent</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">stop</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">active</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">cleanupEffect</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">);</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u5148\u5C06effect\u6E05\u9664\u6389</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">active</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u5728\u5C06\u5176\u53D8\u6210\u5931\u6D3B\u72B6\u6001</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">effect</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fn</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#59873A;">options</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;"> =</span><span style="color:#393A34;"> </span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{})</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">_effect</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#59873A;">ReactiveEffect</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fn</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">options</span><span style="color:#999999;">.</span><span style="color:#B07D48;">scheduler</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">_effect</span><span style="color:#999999;">.</span><span style="color:#59873A;">run</span><span style="color:#999999;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">runner</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">_effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">run</span><span style="color:#999999;">.</span><span style="color:#59873A;">bind</span><span style="color:#999999;">(</span><span style="color:#B07D48;">_effect</span><span style="color:#999999;">);</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u4FDD\u8BC1 _effect\u6267\u884C\u7684\u65F6\u5019this\u662F\u5F53\u524D\u7684effect</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">runner</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">_effect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">runner</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// WeakMap: { Map: Set }</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#B07D48;">targetMap</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#59873A;">WeakMap</span><span style="color:#999999;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * \u4F9D\u8D56\u6536\u96C6</span></span>
<span class="line"><span style="color:#A0ADA0;"> * </span><span style="color:#999999;">@</span><span style="color:#1E754F;">param</span><span style="color:#A0ADA0;"> </span><span style="color:#B07D48;">target</span></span>
<span class="line"><span style="color:#A0ADA0;"> * </span><span style="color:#999999;">@</span><span style="color:#1E754F;">param</span><span style="color:#A0ADA0;"> </span><span style="color:#B07D48;">key</span></span>
<span class="line"><span style="color:#A0ADA0;"> * </span><span style="color:#999999;">@</span><span style="color:#1E754F;">returns</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">track</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// \u53D6\u503C\u64CD\u4F5C\u6CA1\u6709\u53D1\u751F\u5728effect\u4E2D</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">let </span><span style="color:#B07D48;">depsMap</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">targetMap</span><span style="color:#999999;">.</span><span style="color:#59873A;">get</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">depsMap</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">targetMap</span><span style="color:#999999;">.</span><span style="color:#59873A;">set</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">depsMap</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Map</span><span style="color:#999999;">()));</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">let </span><span style="color:#B07D48;">dep</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">depsMap</span><span style="color:#999999;">.</span><span style="color:#59873A;">get</span><span style="color:#999999;">(</span><span style="color:#B07D48;">key</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">depsMap</span><span style="color:#999999;">.</span><span style="color:#59873A;">set</span><span style="color:#999999;">(</span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">dep</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Set</span><span style="color:#999999;">()));</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">trackEffects</span><span style="color:#999999;">(</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">trackEffects</span><span style="color:#999999;">(</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">let </span><span style="color:#B07D48;">shouldTrack</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> !</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">.</span><span style="color:#59873A;">has</span><span style="color:#999999;">(</span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// \u4E00\u4E2A\u5C5E\u6027\u5BF9\u5E94\u591A\u4E2Aeffect\uFF0C\u4E00\u4E2Aeffect\u5BF9\u5E94\u7740\u591A\u79CD\u5C5E\u6027</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// \u5C5E\u6027\u548Ceffect\u7684\u5173\u7CFB\u662F\u591A\u5BF9\u5BF9\u7684\u5173\u7CFB</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">shouldTrack</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">dep</span><span style="color:#999999;">.</span><span style="color:#59873A;">add</span><span style="color:#999999;">(</span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">deps</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">);</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u540E\u7EED\u9700\u8981\u901A\u8FC7effect\u6765\u6E05\u7406\u7684\u65F6\u5019\u53EF\u4EE5\u53BB\u4F7F\u7528</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * \u6D3E\u53D1\u66F4\u65B0</span></span>
<span class="line"><span style="color:#A0ADA0;"> * </span><span style="color:#999999;">@</span><span style="color:#1E754F;">param</span><span style="color:#A0ADA0;"> </span><span style="color:#B07D48;">target</span></span>
<span class="line"><span style="color:#A0ADA0;"> * </span><span style="color:#999999;">@</span><span style="color:#1E754F;">param</span><span style="color:#A0ADA0;"> </span><span style="color:#B07D48;">key</span></span>
<span class="line"><span style="color:#A0ADA0;"> * </span><span style="color:#999999;">@</span><span style="color:#1E754F;">param</span><span style="color:#A0ADA0;"> </span><span style="color:#B07D48;">newValue</span></span>
<span class="line"><span style="color:#A0ADA0;"> * </span><span style="color:#999999;">@</span><span style="color:#1E754F;">param</span><span style="color:#A0ADA0;"> </span><span style="color:#B07D48;">oldValue</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">trigger</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newValue</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">oldValue</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">depsMap</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">targetMap</span><span style="color:#999999;">.</span><span style="color:#59873A;">get</span><span style="color:#999999;">(</span><span style="color:#B07D48;">target</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">depsMap</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">dep</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">depsMap</span><span style="color:#999999;">.</span><span style="color:#59873A;">get</span><span style="color:#999999;">(</span><span style="color:#B07D48;">key</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">triggerEffects</span><span style="color:#999999;">(</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">triggerEffects</span><span style="color:#999999;">(</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">effects</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">[...</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">effects</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">((</span><span style="color:#B07D48;">effect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">activeEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">scheduler</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#59873A;">run</span><span style="color:#999999;">();</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u6BCF\u6B21\u8C03run\u65B9\u6CD5\u90FD\u4F1A\u91CD\u65B0\u4F9D\u8D56\u6536\u96C6</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#59873A;">scheduler</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-4-\u5206\u652F\u5207\u6362\u4E0E-cleanup" tabindex="-1">4.4 \u5206\u652F\u5207\u6362\u4E0E cleanup <a class="header-anchor" href="#_4-4-\u5206\u652F\u5207\u6362\u4E0E-cleanup" aria-hidden="true">#</a></h3><p>\u5982\u679C\u5728\u526F\u4F5C\u7528\u51FD\u6570\u5185\u90E8\u51FA\u73B0\u4E09\u5143\u8868\u8FBE\u5F0F\uFF0C\u4F1A\u6839\u636E\u6761\u4EF6\u5224\u65AD\u6267\u884C\u4E0D\u540C\u7684\u4EE3\u7801\u5206\u652F\u3002\u5F53\u6761\u4EF6\u5224\u65AD\u4F9D\u8D56\u4E8E\u54CD\u5E94\u5F0F\u6570\u636E\u65F6\uFF0C\u503C\u7684\u53D8\u5316\u6267\u884C\u7684\u8868\u8FBE\u5F0F\u4E5F\u4F1A\u4E0D\u540C\u3002\u8FD9\u5C31\u662F\u5206\u652F\u5207\u6362</p><p>\u800C\u5206\u652F\u5207\u6362\u53EF\u80FD\u4F1A\u9057\u7559\u4E4B\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570\uFF0C\u800C\u5F53\u524D\u5E76\u4E0D\u4F9D\u8D56\uFF0C\u6240\u4EE5\u8981\u5728<strong>\u6BCF\u6B21\u6267\u884C\u526F\u4F5C\u7528\u51FD\u6570\u4E4B\u524D\u6E05\u9664\u5F53\u524D\u526F\u4F5C\u7528\u51FD\u6570\u6240\u4F9D\u8D56\u7684\u526F\u4F5C\u7528\u51FD\u6570\uFF0C\u5728\u6267\u884C\u526F\u4F5C\u7528\u51FD\u6570\u91CD\u65B0\u8FDB\u884C\u4F9D\u8D56\u6536\u96C6</strong></p><h3 id="_4-5-\u5D4C\u5957\u7684-effect-\u4E0E-effect-\u6808" tabindex="-1">4.5 \u5D4C\u5957\u7684 effect \u4E0E effect \u6808 <a class="header-anchor" href="#_4-5-\u5D4C\u5957\u7684-effect-\u4E0E-effect-\u6808" aria-hidden="true">#</a></h3><p>\u526F\u4F5C\u7528\u51FD\u6570\u662F\u53EF\u4EE5\u88AB\u5D4C\u5957\u7684\uFF0C\u800C\u5185\u90E8\u7684\u526F\u4F5C\u7528\u51FD\u6570\u5E94\u8BE5\u53EA\u6536\u96C6\u81EA\u8EAB\u5185\u90E8\u7684\u54CD\u5E94\u5F0F\u53D8\u91CF\u5C5E\u6027\uFF0C\u76F8\u4E92\u5E76\u4E0D\u5F71\u54CD</p><p>\u53EF\u4EE5\u901A\u8FC7\u7ED9 <strong>ReactiveEffect</strong> \u6DFB\u52A0\u4E00\u4E2A\u5C5E\u6027 parent\uFF08\u9ED8\u8BA4\u662F <code>undefined</code>\uFF09 \u6765\u8BB0\u5F55\u81EA\u5DF1\u7684\u7236\u7EA7\u526F\u4F5C\u7528\u51FD\u6570</p><p>\u800C\u5728\u6267\u884C\u5B8C\u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570\u5C06\u81EA\u5DF1\u7684\u7236\u7EA7\u8FD4\u56DE\u7ED9<code>activeEffect</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">ReactiveEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">active</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">deps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[];</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u8BB0\u5F55\u8BE5\u526F\u4F5C\u7528\u51FD\u6570\u4F9D\u8D56\u54EA\u4E00\u4E9B\u4F9D\u8D56\u9879</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u5904\u7406\u526F\u4F5C\u7528\u51FD\u6570\u5D4C\u5957\u95EE\u9898</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fn</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">private</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">scheduler</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">run</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u5982\u679C\u662F\u975E\u6FC0\u6D3B\u72B6\u6001\u53EA\u8981\u6267\u884C\u4E00\u6B21\u51FD\u6570\u5373\u53EF</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">active</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">fn</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u5176\u4ED6\u60C5\u51B5\u4E0B \u610F\u601D\u7740\u662F\u6FC0\u6D3B\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u8BB0\u5F55\u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">activeEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u6BCF\u6B21\u6267\u884Ceffect\u4E4B\u524D \u5E94\u8BE5\u6E05\u7406\u4E00\u904Deffect\u4E2D\u4F9D\u8D56\u7684\u6240\u6709\u5C5E\u6027</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">cleanupEffect</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">fn</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">finally</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u5C06\u81EA\u5DF1\u7684\u7236\u7EA7\u8D4B\u503C\u7ED9activeEffect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">activeEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parent</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">ReactiveEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">active</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">deps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[];</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u8BB0\u5F55\u8BE5\u526F\u4F5C\u7528\u51FD\u6570\u4F9D\u8D56\u54EA\u4E00\u4E9B\u4F9D\u8D56\u9879</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u5904\u7406\u526F\u4F5C\u7528\u51FD\u6570\u5D4C\u5957\u95EE\u9898</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fn</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">private</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">scheduler</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">run</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u5982\u679C\u662F\u975E\u6FC0\u6D3B\u72B6\u6001\u53EA\u8981\u6267\u884C\u4E00\u6B21\u51FD\u6570\u5373\u53EF</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">active</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">fn</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u5176\u4ED6\u60C5\u51B5\u4E0B \u610F\u601D\u7740\u662F\u6FC0\u6D3B\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u8BB0\u5F55\u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">activeEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u6BCF\u6B21\u6267\u884Ceffect\u4E4B\u524D \u5E94\u8BE5\u6E05\u7406\u4E00\u904Deffect\u4E2D\u4F9D\u8D56\u7684\u6240\u6709\u5C5E\u6027</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">cleanupEffect</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">fn</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">finally</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u5C06\u81EA\u5DF1\u7684\u7236\u7EA7\u8D4B\u503C\u7ED9activeEffect</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">activeEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parent</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-6-\u907F\u514D\u65E0\u9650\u9012\u5F52\u5FAA\u73AF" tabindex="-1">4.6 \u907F\u514D\u65E0\u9650\u9012\u5F52\u5FAA\u73AF <a class="header-anchor" href="#_4-6-\u907F\u514D\u65E0\u9650\u9012\u5F52\u5FAA\u73AF" aria-hidden="true">#</a></h3><p>\u6709\u53EF\u80FD\u4F1A\u51FA\u73B0\u8FD9\u79CD\u60C5\u51B5<strong>\u5728\u5F53\u524D\u6267\u884C\u7684\u526F\u4F5C\u7528\u51FD\u6570\u53BB\u4FEE\u6539\u6240\u4F9D\u8D56\u7684\u54CD\u5E94\u5F0F\u6570\u636E\uFF0C\u90A3\u4E48\u53C8\u4F1A\u89E6\u53D1\u6D3E\u53D1\u66F4\u65B0\u51FD\u6570\uFF0C\u5BFC\u81F4\u65E0\u9650\u9012\u5F52\u9020\u6210\u6808\u6EA2\u51FA\u95EE\u9898</strong></p><p>\u89E3\u51B3\u65B9\u6848\uFF1A\u5728\u6D3E\u53D1\u66F4\u65B0\u51FD\u6570 <code>trigger</code> \u4E2D\u6267\u884C\u526F\u4F5C\u7528\u51FD\u6570\u6DFB\u52A0\u4E00\u4E2A\u5224\u65AD\uFF1A<strong>\u5982\u679C\u6D3E\u53D1\u66F4\u65B0\u6240\u6267\u884C\u7684\u526F\u4F5C\u7528\u51FD\u6570\u548C\u5F53\u524D\u6267\u884C\u7684\u526F\u4F5C\u7528\u51FD\u6570\u662F\u540C\u4E00\u4E2A\uFF0C\u5219\u4E0D\u89E6\u53D1\u6267\u884C</strong></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">triggerEffects</span><span style="color:#666666;">(</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">effects</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">[...</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">effects</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">((</span><span style="color:#BD976A;">effect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u6DFB\u52A0\u5982\u4E0B\u5224\u65AD\uFF08\u53EA\u6709\u4E0D\u7B49\u4E8E\u7684\u65F6\u5019\u60C5\u51B5\u4F1A\u6267\u884C\uFF09</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">activeEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#80A665;">run</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">triggerEffects</span><span style="color:#999999;">(</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">effects</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">[...</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">effects</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">((</span><span style="color:#B07D48;">effect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u6DFB\u52A0\u5982\u4E0B\u5224\u65AD\uFF08\u53EA\u6709\u4E0D\u7B49\u4E8E\u7684\u65F6\u5019\u60C5\u51B5\u4F1A\u6267\u884C\uFF09</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">activeEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#59873A;">run</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-7-\u8C03\u5EA6\u6267\u884C" tabindex="-1">4.7 \u8C03\u5EA6\u6267\u884C <a class="header-anchor" href="#_4-7-\u8C03\u5EA6\u6267\u884C" aria-hidden="true">#</a></h3><p>\u53EF\u8C03\u5EA6\u6027\u662F\u54CD\u5E94\u5F0F\u7CFB\u7EDF\u975E\u5E38\u91CD\u8981\u7684\u7279\u6027\u3002\u662F\u6240\u8C13\u53EF\u8C03\u5EA6\uFF0C\u6307\u7684\u662F\u5F53 trigger \u89E6\u53D1\u526F\u4F5C\u7528\u51FD\u6570\u91CD\u65B0\u6267\u884C\u65F6\uFF0C\u5F00\u53D1\u8005\u6709\u80FD\u529B\u51B3\u5B9A\u526F\u4F5C\u7528\u51FD\u6570\u6267\u884C\u7684\u65F6\u673A\u3001\u6B21\u6570\u4EE5\u53CA\u65B9\u5F0F</p><p>\u6240\u4EE5\u5728 <code>effect</code> \u51FD\u6570\u6DFB\u52A0\u7B2C\u4E8C\u4E2A\u53C2\u6570 <code>scheduler</code> \u8C03\u5EA6\u5668</p><p><strong>effect.ts</strong></p><p><code>options.scheduler</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">ReactiveEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">active</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">deps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[];</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u8BB0\u5F55\u8BE5\u526F\u4F5C\u7528\u51FD\u6570\u4F9D\u8D56\u54EA\u4E00\u4E9B\u4F9D\u8D56\u9879</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u5904\u7406\u526F\u4F5C\u7528\u51FD\u6570\u5D4C\u5957\u95EE\u9898</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// scheduler \u8C03\u5EA6\u6267\u884C\uFF0C\u6211\u4EEC\u53EF\u4EE5\u81EA\u5DF1\u51B3\u5B9A\u526F\u4F5C\u7528\u51FD\u6570\u6267\u884C\u7684\u65F6\u673A\u3001\u6B21\u6570\u3001\u53CA\u6267\u884C\u65B9\u5F0F</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fn</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">private</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">scheduler</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">run</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// \u5982\u679C\u662F\u975E\u6FC0\u6D3B\u72B6\u6001\u53EA\u8981\u6267\u884C\u4E00\u6B21\u51FD\u6570\u5373\u53EF</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">active</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">fn</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u5176\u4ED6\u60C5\u51B5\u4E0B \u610F\u601D\u7740\u662F\u6FC0\u6D3B\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u8BB0\u5F55\u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">activeEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u6BCF\u6B21\u6267\u884Ceffect\u4E4B\u524D \u5E94\u8BE5\u6E05\u7406\u4E00\u904Deffect\u4E2D\u4F9D\u8D56\u7684\u6240\u6709\u5C5E\u6027</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">cleanupEffect</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">fn</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">finally</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#BD976A;">activeEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parent</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">effect</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fn</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">options</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;"> =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{})</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">_effect</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#80A665;">ReactiveEffect</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fn</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">options</span><span style="color:#666666;">.</span><span style="color:#BD976A;">scheduler</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">_effect</span><span style="color:#666666;">.</span><span style="color:#80A665;">run</span><span style="color:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">runner</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">_effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">run</span><span style="color:#666666;">.</span><span style="color:#80A665;">bind</span><span style="color:#666666;">(</span><span style="color:#BD976A;">_effect</span><span style="color:#666666;">);</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u4FDD\u8BC1 _effect\u6267\u884C\u7684\u65F6\u5019this\u662F\u5F53\u524D\u7684effect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">runner</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">_effect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">runner</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">ReactiveEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">active</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">deps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[];</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u8BB0\u5F55\u8BE5\u526F\u4F5C\u7528\u51FD\u6570\u4F9D\u8D56\u54EA\u4E00\u4E9B\u4F9D\u8D56\u9879</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u5904\u7406\u526F\u4F5C\u7528\u51FD\u6570\u5D4C\u5957\u95EE\u9898</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// scheduler \u8C03\u5EA6\u6267\u884C\uFF0C\u6211\u4EEC\u53EF\u4EE5\u81EA\u5DF1\u51B3\u5B9A\u526F\u4F5C\u7528\u51FD\u6570\u6267\u884C\u7684\u65F6\u673A\u3001\u6B21\u6570\u3001\u53CA\u6267\u884C\u65B9\u5F0F</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fn</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">private</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">scheduler</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">run</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// \u5982\u679C\u662F\u975E\u6FC0\u6D3B\u72B6\u6001\u53EA\u8981\u6267\u884C\u4E00\u6B21\u51FD\u6570\u5373\u53EF</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">active</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">fn</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u5176\u4ED6\u60C5\u51B5\u4E0B \u610F\u601D\u7740\u662F\u6FC0\u6D3B\u7684\u72B6\u6001</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u8BB0\u5F55\u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">activeEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u6BCF\u6B21\u6267\u884Ceffect\u4E4B\u524D \u5E94\u8BE5\u6E05\u7406\u4E00\u904Deffect\u4E2D\u4F9D\u8D56\u7684\u6240\u6709\u5C5E\u6027</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">cleanupEffect</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">fn</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">finally</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B07D48;">activeEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parent</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">effect</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fn</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">options</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;"> =</span><span style="color:#393A34;"> </span><span style="color:#999999;">{})</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">_effect</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#59873A;">ReactiveEffect</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fn</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">options</span><span style="color:#999999;">.</span><span style="color:#B07D48;">scheduler</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">_effect</span><span style="color:#999999;">.</span><span style="color:#59873A;">run</span><span style="color:#999999;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">runner</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">_effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">run</span><span style="color:#999999;">.</span><span style="color:#59873A;">bind</span><span style="color:#999999;">(</span><span style="color:#B07D48;">_effect</span><span style="color:#999999;">);</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u4FDD\u8BC1 _effect\u6267\u884C\u7684\u65F6\u5019this\u662F\u5F53\u524D\u7684effect</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">runner</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">_effect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">runner</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><p>\u5F53\u54CD\u5E94\u5F0F\u6570\u636E\u53D1\u751F\u53D8\u5316\u65F6\uFF0C\u6700\u540E\u5C31\u4F1A\u8D70\u5230 <strong>triggerEffects</strong> \u51FD\u6570\u4E2D</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">triggerEffects</span><span style="color:#666666;">(</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">effects</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">[...</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">effects</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">((</span><span style="color:#BD976A;">effect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">activeEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">scheduler</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#80A665;">run</span><span style="color:#666666;">();</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u6BCF\u6B21\u8C03run\u65B9\u6CD5\u90FD\u4F1A\u91CD\u65B0\u4F9D\u8D56\u6536\u96C6</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// \u5982\u679C\u4F20\u9012\u4E86 scheduler \u5219\u53BB\u6267\u884C\u7528\u6237\u7684\u8C03\u5EA6\u51FD\u6570 \u800C\u4E0D\u53BB\u6267\u884C\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#80A665;">scheduler</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">triggerEffects</span><span style="color:#999999;">(</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">effects</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">[...</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">effects</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">((</span><span style="color:#B07D48;">effect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">activeEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">scheduler</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#59873A;">run</span><span style="color:#999999;">();</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u6BCF\u6B21\u8C03run\u65B9\u6CD5\u90FD\u4F1A\u91CD\u65B0\u4F9D\u8D56\u6536\u96C6</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// \u5982\u679C\u4F20\u9012\u4E86 scheduler \u5219\u53BB\u6267\u884C\u7528\u6237\u7684\u8C03\u5EA6\u51FD\u6570 \u800C\u4E0D\u53BB\u6267\u884C\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#59873A;">scheduler</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-8-\u8BA1\u7B97\u5C5E\u6027-computed" tabindex="-1">4.8 \u8BA1\u7B97\u5C5E\u6027 computed <a class="header-anchor" href="#_4-8-\u8BA1\u7B97\u5C5E\u6027-computed" aria-hidden="true">#</a></h3><p>\u8BA1\u7B97\u5C5E\u6027\u7684\u76EE\u7684\u662F\u6839\u636E\u72B6\u6001\u884D\u751F\u5C5E\u6027\uFF0C\u6211\u4EEC\u5E0C\u671B\u8FD9\u4E2A\u5C5E\u6027\u6709\u7F13\u5B58\u529F\u80FD\uFF0C\u5982\u679C\u4F9D\u8D56\u7684\u6570\u636E\u4E0D\u53D8\u5C31\u4E0D\u4F1A\u91CD\u65B0\u8BA1\u7B97</p><p>\u9ED8\u8BA4\u4E0D\u6267\u884C,\u5F53\u6211\u4EEC\u53D6\u503C\u65F6\u624D\u4F1A\u8C03\u7528\uFF08\u5177\u6709\u7F13\u5B58\u529F\u80FD\u5F53\u53D6\u503C\u591A\u6B21\u53EA\u6267\u884C\u4E00\u6B21\uFF0C\u53EA\u6709\u5F53\u4F9D\u8D56\u7684\u503C\u53D1\u751F\u53D8\u5316\u624D\u4F1A\u91CD\u65B0\u6267\u884C\uFF09</p><p>\u8BA1\u7B97\u5C5E\u6027 \u5185\u90E8\u6709\u4E2A\u53D8\u91CF\u6765\u63A7\u5236\u662F\u5426\u91CD\u65B0\u6267\u884C dirty\uFF08\u9ED8\u8BA4\u662F true\uFF0C\u6B64\u65F6\u7528\u6237\u4F1A\u6267\u884C\u6B64\u65B9\u6CD5\uFF0C\u62FF\u5230\u8FD4\u56DE\u7ED3\u679C\u8FD4\u56DE\u5E76\u4E14\u7F13\u5B58\u8D77\u6765\uFF0C\u5C06 dirty \u53D8\u4E3A false\uFF09\u3002\u518D\u6B21\u53D6\u503C\u5219 dirty \u4E3A false \u5C31\u53BB\u62FF\u7F13\u5B58\u7684\u7ED3\u679C</p><p>\u5982\u679C\u4F9D\u8D56\u9879\u53D1\u751F\u53D8\u5316\uFF0C\u4F1A\u518D\u6B21\u66F4\u65B0 dirty \u53D8\u4E3A true\uFF0C\u518D\u53D6\u503C\u7684\u65F6\u5019\u5C31\u4F1A\u6267\u884C\u62FF\u5230\u65B0\u503C</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isFunction</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">@vue/shared</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">ReactiveEffect</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">trackEffects</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">triggerEffects</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">./effect</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">noop</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">()</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">class</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">ComputedRefImpl</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">dep</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">effect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">__v_isRef</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u610F\u601D\u7740\u6709\u8FD9\u4E2A\u5C5E\u6027\uFF0C\u9700\u8981\u7528 .value\u6765\u53D6\u503C</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">_dirty</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u9ED8\u8BA4\u662F\u810F\u7684</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">_value</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// \u9ED8\u8BA4\u7684\u7F13\u5B58\u7ED3\u679C</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">constructor</span><span style="color:#666666;">(</span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">getter</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">public</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">setter</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// getter \u51FD\u6570\u91CC\u7684\u54CD\u5E94\u5F0F\u53D8\u91CF\u4F1A\u88AB\u6536\u96C6\uFF0C\u5F53\u53D1\u751F\u53D8\u5316\u662F\u5C31\u4F1A\u6267\u884C\u8C03\u5EA6\u51FD\u6570\u91CC\u7684\u5185\u5BB9</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">ReactiveEffect</span><span style="color:#666666;">(</span><span style="color:#BD976A;">getter</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u53EA\u6709\u6570\u636E\u4E00\u904D\uFF0C\u5C31\u628A _dirty\u6539\u6210true \u4E0B\u6B21\u53D6\u503Cvalue\u5C31\u53C8\u4F1A\u91CD\u65B0\u6267\u884C</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_dirty</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u89E6\u53D1\u6267\u884C\u8BA1\u7B97\u5C5E\u6027\u8BE5\u6240\u4F9D\u8D56\u7684\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">triggerEffects</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">dep</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u6700\u540E\uFF1A\u8FBE\u5230\u54CD\u5E94\u5F0F\u6570\u636E\u53D1\u751F\u53D8\u5316\uFF0C\u4E0B\u4E00\u6B21\u8BBF\u95EE\u8BA1\u7B97\u5C5E\u6027\u65F6\u6570\u636E\u53D1\u751F\u66F4\u65B0\uFF0C\u4F9D\u8D56\u8BA1\u7B97\u5C5E\u6027\u7684\u526F\u4F5C\u7528\u51FD\u6570\u4E5F\u8FDB\u884C\u89E6\u53D1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">get</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">value</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">activeEffect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u5982\u679C\u6709 activeEffect \u610F\u5473\u7740\u8FD9\u4E2A\u8BA1\u7B97\u5C5E\u6027\u662F\u5728\u526F\u4F5C\u7528\u51FD\u6570\u8C03\u7528\u7684 \u6211\u4EEC\u9700\u8981\u8BA9\u8BA1\u7B97\u5C5E\u6027\u6536\u96C6\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">trackEffects</span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">dep</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">dep</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Set</span><span style="color:#666666;">()));</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_dirty</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u53D6\u503C\u624D\u6267\u884C\uFF0C\u5E76\u4E14\u628A\u53D6\u5230\u7684\u503C\u7F13\u5B58\u8D77\u6765</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_value</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#80A665;">run</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// \u610F\u5473\u7740\u8FD9\u53BB\u8FC7\u4E86 \u88AB\u7F13\u5B58\u4E86</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_dirty</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_value</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">set</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">value</span><span style="color:#666666;">(</span><span style="color:#BD976A;">newValue</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">setter</span><span style="color:#666666;">(</span><span style="color:#BD976A;">newValue</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">computed</span><span style="color:#666666;">(</span><span style="color:#BD976A;">getterOptions</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">let </span><span style="color:#BD976A;">onlyGetter</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#80A665;">isFunction</span><span style="color:#666666;">(</span><span style="color:#BD976A;">getterOptions</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">let </span><span style="color:#BD976A;">getter</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">let </span><span style="color:#BD976A;">setter</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">onlyGetter</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">getter</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">getterOptions</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">setter</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">noop</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">getter</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">getterOptions</span><span style="color:#666666;">.</span><span style="color:#BD976A;">get</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">setter</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">getterOptions</span><span style="color:#666666;">.</span><span style="color:#BD976A;">set</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">noop</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">ComputedRefImpl</span><span style="color:#666666;">(</span><span style="color:#BD976A;">getter</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">setter</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isFunction</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">@vue/shared</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">ReactiveEffect</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">trackEffects</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">triggerEffects</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">./effect</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">noop</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">()</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">class</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">ComputedRefImpl</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">dep</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">effect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">__v_isRef</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u610F\u601D\u7740\u6709\u8FD9\u4E2A\u5C5E\u6027\uFF0C\u9700\u8981\u7528 .value\u6765\u53D6\u503C</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">_dirty</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u9ED8\u8BA4\u662F\u810F\u7684</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">_value</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// \u9ED8\u8BA4\u7684\u7F13\u5B58\u7ED3\u679C</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">constructor</span><span style="color:#999999;">(</span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">getter</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">public</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">setter</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// getter \u51FD\u6570\u91CC\u7684\u54CD\u5E94\u5F0F\u53D8\u91CF\u4F1A\u88AB\u6536\u96C6\uFF0C\u5F53\u53D1\u751F\u53D8\u5316\u662F\u5C31\u4F1A\u6267\u884C\u8C03\u5EA6\u51FD\u6570\u91CC\u7684\u5185\u5BB9</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">ReactiveEffect</span><span style="color:#999999;">(</span><span style="color:#B07D48;">getter</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u53EA\u6709\u6570\u636E\u4E00\u904D\uFF0C\u5C31\u628A _dirty\u6539\u6210true \u4E0B\u6B21\u53D6\u503Cvalue\u5C31\u53C8\u4F1A\u91CD\u65B0\u6267\u884C</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_dirty</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u89E6\u53D1\u6267\u884C\u8BA1\u7B97\u5C5E\u6027\u8BE5\u6240\u4F9D\u8D56\u7684\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">triggerEffects</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">dep</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u6700\u540E\uFF1A\u8FBE\u5230\u54CD\u5E94\u5F0F\u6570\u636E\u53D1\u751F\u53D8\u5316\uFF0C\u4E0B\u4E00\u6B21\u8BBF\u95EE\u8BA1\u7B97\u5C5E\u6027\u65F6\u6570\u636E\u53D1\u751F\u66F4\u65B0\uFF0C\u4F9D\u8D56\u8BA1\u7B97\u5C5E\u6027\u7684\u526F\u4F5C\u7528\u51FD\u6570\u4E5F\u8FDB\u884C\u89E6\u53D1</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">get</span><span style="color:#393A34;"> </span><span style="color:#59873A;">value</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">activeEffect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u5982\u679C\u6709 activeEffect \u610F\u5473\u7740\u8FD9\u4E2A\u8BA1\u7B97\u5C5E\u6027\u662F\u5728\u526F\u4F5C\u7528\u51FD\u6570\u8C03\u7528\u7684 \u6211\u4EEC\u9700\u8981\u8BA9\u8BA1\u7B97\u5C5E\u6027\u6536\u96C6\u526F\u4F5C\u7528\u51FD\u6570</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">trackEffects</span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">dep</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">dep</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Set</span><span style="color:#999999;">()));</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_dirty</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u53D6\u503C\u624D\u6267\u884C\uFF0C\u5E76\u4E14\u628A\u53D6\u5230\u7684\u503C\u7F13\u5B58\u8D77\u6765</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_value</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#59873A;">run</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// \u610F\u5473\u7740\u8FD9\u53BB\u8FC7\u4E86 \u88AB\u7F13\u5B58\u4E86</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_dirty</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_value</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">set</span><span style="color:#393A34;"> </span><span style="color:#59873A;">value</span><span style="color:#999999;">(</span><span style="color:#B07D48;">newValue</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">setter</span><span style="color:#999999;">(</span><span style="color:#B07D48;">newValue</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">computed</span><span style="color:#999999;">(</span><span style="color:#B07D48;">getterOptions</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">let </span><span style="color:#B07D48;">onlyGetter</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#59873A;">isFunction</span><span style="color:#999999;">(</span><span style="color:#B07D48;">getterOptions</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">let </span><span style="color:#B07D48;">getter</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">let </span><span style="color:#B07D48;">setter</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">onlyGetter</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">getter</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">getterOptions</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">setter</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">noop</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">getter</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">getterOptions</span><span style="color:#999999;">.</span><span style="color:#B07D48;">get</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">setter</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">getterOptions</span><span style="color:#999999;">.</span><span style="color:#B07D48;">set</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">noop</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">ComputedRefImpl</span><span style="color:#999999;">(</span><span style="color:#B07D48;">getter</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">setter</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div>`,35),e=[o];function c(t,r,y,A,D,B){return a(),n("div",null,e)}const C=s(l,[["render",c]]);export{i as __pageData,C as default};
